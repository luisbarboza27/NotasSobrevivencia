<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Análisis de Sobrevivencia - 2&nbsp; Estimación No-Paramétrica</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./PH.html" rel="next">
<link href="./Preliminares.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Estimación No-Paramétrica</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Análisis de Sobrevivencia</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Introducción</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Preliminares.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Preliminares</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./estNP.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Estimación No-Paramétrica</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PH.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Pruebas de Hipótesis</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">Referencias</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#intervalos-de-confianza-puntuales-de-st" id="toc-intervalos-de-confianza-puntuales-de-st" class="nav-link active" data-scroll-target="#intervalos-de-confianza-puntuales-de-st"><span class="toc-section-number">2.1</span>  Intervalos de confianza puntuales de <span class="math inline">\(S(t)\)</span></a></li>
  <li><a href="#bandas-de-confianza-para-st" id="toc-bandas-de-confianza-para-st" class="nav-link" data-scroll-target="#bandas-de-confianza-para-st"><span class="toc-section-number">2.2</span>  Bandas de confianza para <span class="math inline">\(S(t)\)</span></a></li>
  <li><a href="#estimación-del-tiempo-medio-y-mediano-de-sobrevivencia" id="toc-estimación-del-tiempo-medio-y-mediano-de-sobrevivencia" class="nav-link" data-scroll-target="#estimación-del-tiempo-medio-y-mediano-de-sobrevivencia"><span class="toc-section-number">2.3</span>  Estimación del tiempo medio y mediano de sobrevivencia</a></li>
  <li><a href="#estimadores-para-datos-censurados-por-la-derecha-y-truncados-por-la-izquierda" id="toc-estimadores-para-datos-censurados-por-la-derecha-y-truncados-por-la-izquierda" class="nav-link" data-scroll-target="#estimadores-para-datos-censurados-por-la-derecha-y-truncados-por-la-izquierda"><span class="toc-section-number">2.4</span>  Estimadores para datos censurados por la derecha y truncados por la izquierda</a></li>
  <li><a href="#estimadores-para-riesgos-en-competencia" id="toc-estimadores-para-riesgos-en-competencia" class="nav-link" data-scroll-target="#estimadores-para-riesgos-en-competencia"><span class="toc-section-number">2.5</span>  Estimadores para riesgos en competencia</a></li>
  <li><a href="#estimación-de-st-para-otros-esquemas-de-censura" id="toc-estimación-de-st-para-otros-esquemas-de-censura" class="nav-link" data-scroll-target="#estimación-de-st-para-otros-esquemas-de-censura"><span class="toc-section-number">2.6</span>  Estimación de <span class="math inline">\(S(t)\)</span> para otros esquemas de censura</a>
  <ul class="collapse">
  <li><a href="#censura-por-la-izquierda" id="toc-censura-por-la-izquierda" class="nav-link" data-scroll-target="#censura-por-la-izquierda"><span class="toc-section-number">2.6.1</span>  Censura por la izquierda</a></li>
  <li><a href="#censura-doble" id="toc-censura-doble" class="nav-link" data-scroll-target="#censura-doble"><span class="toc-section-number">2.6.2</span>  Censura doble</a></li>
  <li><a href="#censura-por-intervalo" id="toc-censura-por-intervalo" class="nav-link" data-scroll-target="#censura-por-intervalo"><span class="toc-section-number">2.6.3</span>  Censura por intervalo</a></li>
  </ul></li>
  <li><a href="#laboratorio" id="toc-laboratorio" class="nav-link" data-scroll-target="#laboratorio"><span class="toc-section-number">2.7</span>  Laboratorio</a>
  <ul class="collapse">
  <li><a href="#ajustes-básicos" id="toc-ajustes-básicos" class="nav-link" data-scroll-target="#ajustes-básicos"><span class="toc-section-number">2.7.1</span>  Ajustes básicos</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="estNP" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Estimación No-Paramétrica</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Con el fin de realizar estimación (no paramétrica) de las funciones de sobrevivencia, vamos a considerar primero un esquema de observaciones truncadas por la izquierda y censuradas por la derecha. Además, vamos a asumir que el tiempo de censura no está relacionado con el tiempo del evento (independencia observaciones-censuras).</p>
<p>Sea <span class="math inline">\(t_1&lt;t_2&lt;\cdots &lt;t_D\)</span>, <span class="math inline">\(D\)</span> distintos tiempos de ocurrencia del evento de riesgo. Además asuma que en tiempo <span class="math inline">\(t_i\)</span> ocurrieron <span class="math inline">\(d_i\)</span> eventos, para <span class="math inline">\(1=1,\ldots,D\)</span>. Sea <span class="math inline">\(Y_i\)</span> el número de <em>individuos en riesgo</em> al momento <span class="math inline">\(t_i\)</span>. Estos <span class="math inline">\(Y_i\)</span> individuos sobrevivirán al riesgo o bien tendrán el riesgo en momento <span class="math inline">\(t_i\)</span> (<span class="math inline">\(d_i\)</span>).</p>
<p>Por lo tanto, un estimador de la probabilidad de experimentar el evento en momento <span class="math inline">\(t_i\)</span>, dado que no se ha experimentado el riesgo hasta antes de <span class="math inline">\(t_i\)</span> es:</p>
<p><span class="math display">\[\frac{d_i}{Y_i}\]</span></p>
<p>El estimador estándar de <span class="math inline">\(S(t)\)</span> es el <strong>estimador de Kaplan-Meier</strong>. Si <span class="math inline">\(t\leq t_{\text{max}}\)</span>:</p>
<span class="math display">\[\begin{align*}
    \hat S(t)=
    \begin{cases}
    1 &amp; \text{si $\quad t&lt;t_1$}\\
    \prod_{t_i\leq t}\left[1-\frac{d_i}{Y_i}\right] &amp; \text{si $\quad t_1\leq t$}.
    \end{cases}
\end{align*}\]</span>
<p>la cual es una función escalonada con respecto a <span class="math inline">\(t\)</span>. La varianza de <span class="math inline">\(\hat S(t)\)</span> puede ser estimada a través de la fórmula de Greenwood:</p>
<p><span class="math display">\[\hat V[\hat S(t)]=\hat S(t)^2\sum_{t_i\leq t}\frac{d_i}{Y_i(Y_i-d_i)}.\]</span></p>
<p>Por otro lado la función acumulativa de riesgo puede ser estimada (plug-in):</p>
<p><span class="math display">\[\hat H(t)=-\log[\hat S(t)].\]</span></p>
<p>Una alternativa al estimador anterior es el <strong>estimador de Nelson-Aalen</strong> (Nelson-Altschuler):</p>
<span class="math display">\[\begin{align*}
    \hat H(t)=
    \begin{cases}
    0 &amp; \text{si $\quad t&lt;t_1$}\\
    \sum_{t_i\leq t}\frac{d_i}{Y_i}  &amp; \text{si $\quad t_1\leq t$}.
    \end{cases}
\end{align*}\]</span>
<p>con varianza:</p>
<p><span class="math display">\[\sigma_H^2(t)=\sum_{t_i\leq t}\frac{d_i}{Y_i^2}\]</span></p>
<p>y usando el estimador anterior, podemos estimar la función de sobrevivencia con:</p>
<p><span class="math display">\[\hat S(t)=\exp[-\hat H(t)]\]</span></p>
<p>Dos principales usos del estimador de Nelson-Aalen:</p>
<p>1- Permite definir una herramienta descriptiva que se usa como método de selección de modelos. Por ejemplo, en el caso exponencial, se sabe que <span class="math inline">\(h\)</span> es constante, es decir <span class="math inline">\(H(t)\)</span> es lineal con respecto a <span class="math inline">\(t\)</span>:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/NelsonAalenH.png" class="img-fluid figure-img" style="width:80.0%"></p>
<p></p><figcaption class="figure-caption">Estimador de Nelson-Aalen vs tiempo</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>permite identificar un modelo exponencial sobre otras alternativas.</p>
<p>2- El estimador de Nelson-Aalen permite obtener estimadores crudos de <span class="math inline">\(h\)</span>.</p>
<p><strong>Nota:</strong> ¿Qué pasa si <span class="math inline">\(t&gt;t_{\text{max}}\)</span>? (extrapolación). Soluciones:</p>
<ul>
<li><span class="math inline">\(\hat S(t)=0\)</span>: el sobreviviente con el tiempo en estudio más grande muere inmediatamente.</li>
<li><span class="math inline">\(\hat S(t)=\hat S(t_{\text{max}})\)</span>: el mismo individuo nunca muere.</li>
<li>Completar <span class="math inline">\(\hat S(t)\)</span> con una exponencial que arranca con <span class="math inline">\(\hat S(t_{\text{max}})\)</span>:</li>
</ul>
<p><span class="math display">\[\hat S(t)=\exp[t\log[\hat S(t_{\text{max}})]/t_{\text{max}}]\]</span></p>
<p><strong>Ejercicio</strong>: Si no hay censura, el estimador de Kaplan-Meier es la función de sobrevivencia empírica.</p>
<section id="intervalos-de-confianza-puntuales-de-st" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="intervalos-de-confianza-puntuales-de-st"><span class="header-section-number">2.1</span> Intervalos de confianza puntuales de <span class="math inline">\(S(t)\)</span></h2>
<p>Sea <span class="math inline">\(\sigma_S(t)^2=\frac{\hat V[\hat S(t)]}{\hat S(t)^2}\)</span>. Si <span class="math inline">\(t_0\)</span> es un punto fijo de tiempo, definimos el intervalo de confianza lineal al <span class="math inline">\(100\cdot (1-\alpha)\)</span>% para <span class="math inline">\(S(t_0)\)</span> como:</p>
<p><span class="math display">\[\hat S(t_0)\pm z_{1-\alpha/2}\sigma_S(t_0)\hat S(t_0)\]</span></p>
<p>Con el fin de mejorar el intervalo de confianza anterior, se puede considerar un intervalo de confianza sobre el logaritmo de <span class="math inline">\(H(t)\)</span>:</p>
<p><span class="math display">\[\log \hat H(t_0)\pm z_{1-\alpha/2}\cdot \sigma^*(t_0)\]</span></p>
<p>donde <span class="math inline">\(\sigma^*(t_0)\)</span> lo tenemos que calcular o bien aproximar. Como <span class="math inline">\(\text{Var}(\hat S(t))\approx \hat S(t)^2\sigma_S(t)^2\)</span> entonces por el método delta (Ejercicio):</p>
<span class="math display">\[\begin{align*}
   \text{Var}[\log H(t_0)]&amp;=\text{Var}[\log(-\log S(t_0))]\\
   &amp;\approx \frac{1}{[\log \hat S(t_0)]^2}\underbrace{\sum_{t_i\leq t}\frac{d_i}{Y_i(Y_i-d_i)}}_{\sigma_S(t_0)^2}
\end{align*}\]</span>
<p>entonces podemos aproximar el término <span class="math inline">\(\sigma^*(t_0)\)</span> y obtener:</p>
<p><span class="math display">\[\log \hat H(t_0)\pm z_{1-\alpha/2}\cdot \frac{1}{\log S(t_0)}\sigma_S(t_0)\]</span></p>
<p>es un intervalo de confianza al <span class="math inline">\(100(1-\alpha)\)</span>’% para <span class="math inline">\(\log[-\log S(t_0)]\)</span>. Entonces:</p>
<p><span class="math display">\[\hat H(t_0)\exp\left[\pm\frac{z_{1-\alpha/2}\sigma_S(t_0)}{\log S(t_0)}\right]\]</span></p>
<p>es un IC para <span class="math inline">\(H(t_0)\)</span> y <span class="math inline">\([\hat S(t_0)^{1/\theta},\hat S(t_0)^\theta]\)</span> donde <span class="math inline">\(\theta=\exp\left[\frac{z_{1-\alpha/2}\sigma_S(t_0)}{\log \hat S(t_0)}\right]\)</span> es el IC al <span class="math inline">\(100(1-\alpha)\)</span>% para <span class="math inline">\(S(t_0)\)</span>.</p>
<p>Otra posibilidad es utilizar la transformación <span class="math inline">\(\text{arcsen}[\hat S(t_0)^{1/2}]\)</span></p>
<p><em>Ventaja</em>: ambas posibilidades permiten que el IC de <span class="math inline">\(S(t_0)\)</span> no salga del intervalo <span class="math inline">\([0,1]\)</span>.</p>
<p>Por otro lado, para muestras pequeñas, el IC con la transformación arcsen es más conservador, seguido del IC con transformación log-log y de último el lineal (sin transformación).</p>
<p><em>Nota</em>: los intervalos log-log y arcsen no son simétricos.</p>
</section>
<section id="bandas-de-confianza-para-st" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="bandas-de-confianza-para-st"><span class="header-section-number">2.2</span> Bandas de confianza para <span class="math inline">\(S(t)\)</span></h2>
<p>Queremos encontrar dos funciones aleatorias <span class="math inline">\(L(t)\)</span> y <span class="math inline">\(U(t)\)</span> tal que:</p>
<p><span class="math display">\[P[L(t)\leq S(t)\leq U(t)\quad \forall t: t_L\leq t\leq t_U]=1-\alpha\]</span></p>
<p>A <span class="math inline">\([L(t),U(t)]\)</span> le llamamos banda de confianza al <span class="math inline">\(100(1-\alpha)\)</span>% para <span class="math inline">\(S(t)\)</span>.</p>
<p>Nair(1984) define el concepto de <strong>Bandas EP</strong>, las cuales son proporcionales a los intervalos puntuales. Sean <span class="math inline">\(t_L&lt;t_U\)</span> tal que <span class="math inline">\(t_L\geq \text{tiempo más pequeño del evento observado}\)</span> y <span class="math inline">\(t_U\leq \text{tiempo más grande del evento observado}\)</span>. Si <span class="math inline">\(n\)</span> es el tamaño de muestra, defina:</p>
<p><span class="math display">\[a_L=\frac{n\sigma_S(t_L)^2}{1+n\sigma_S(t_L)^2},\qquad a_U=\frac{n\sigma_S(t_U)^2}{1+n\sigma_S(t_U)^2}\]</span></p>
<p>y tomando <span class="math inline">\(c_\alpha(a_L,a_U)\)</span> de la tabla C.3 del Klein (también se puede obtener de R) entonces los tres tipos de Banda de confianza al <span class="math inline">\(100(1-\alpha)\)</span>% son:</p>
<ul>
<li><p>Lineal: <span class="math inline">\(\hat S(t)\pm c_\alpha(a_L,a_U)\sigma_S(t)\hat S(t)\)</span></p></li>
<li><p>Log-log; <span class="math inline">\((\hat S(t)^{1/\theta},\hat S(t)^\theta)\)</span>, donde <span class="math inline">\(\theta=\exp\left[\frac{c_\alpha(a_L,a_U)\sigma_S(t)}{\log[\hat S(t)]}\right]\)</span>.</p></li>
<li><p>Arcsen-raíz cuadrada: ver fórmula 4.4.4 del Klein.</p></li>
</ul>
<p>Otro método para construir las bandas es el de Hall y Wellner (1980) (ver Klein).</p>
<p><em>Notas</em>:</p>
<ul>
<li><p>Se pueden construir bandas de confianza para la tasa de riesgo acumulativo.</p></li>
<li><p>Igual que en el caso de los intervalos puntuales, los intervalos log-log y arcsen se comportan mejor bajo muestras pequeñas.</p></li>
</ul>
</section>
<section id="estimación-del-tiempo-medio-y-mediano-de-sobrevivencia" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="estimación-del-tiempo-medio-y-mediano-de-sobrevivencia"><span class="header-section-number">2.3</span> Estimación del tiempo medio y mediano de sobrevivencia</h2>
<p>Recuerden que el tiempo medio de sobrevivencia es:</p>
<p><span class="math display">\[\mu=\int_0^\infty S(t)dt\]</span></p>
<p>Un estimador plug-in para este caso es:</p>
<p><span class="math display">\[\hat \mu=\int_0^\infty\hat S(t)dt\]</span></p>
<p>con el principal inconveniente de que el estimador de Kaplan-Meier está definido hasta un valor de <span class="math inline">\(t\)</span> máximo, llámese <span class="math inline">\(\tau\)</span> (tiempo de sobrevivencia máximo condicionado con respecto a censuras):</p>
<p><span class="math display">\[\hat \mu_\tau=\int_0^\tau \hat S(t)dt\]</span></p>
<p>Normalmente <span class="math inline">\(\tau\)</span> es el tiempo de muerte máximo o bien el tiempo máximo de censura asumiendo muerte del individuo (corrección de Efron). Para el estimador <span class="math inline">\(\mu_\tau\)</span>, su varianza es:</p>
<p><span class="math display">\[\hat V[\hat \mu_\tau]=\sum_{i=1}^D\left[\int_{t_i}^\tau \hat S(t)dt\right]^2\frac{d_i}{Y_i(Y_i-d_i)}\]</span></p>
<p>y un intervalo de confianza para <span class="math inline">\(\mu\)</span> al <span class="math inline">\(100(1-\alpha)\)</span>% es:</p>
<p><span class="math display">\[\hat \mu_\tau\pm z_{1-\alpha/2}\sqrt{\hat V[\hat \mu_\tau]}\]</span></p>
<p>Por otro lado, también es posible estimar cuantiles de la distribución de <span class="math inline">\(T\)</span>:</p>
<p><span class="math display">\[\text{cuantil-}p = x_p = \inf\{t:S(t)\leq 1-p\}\]</span></p>
<p>el cual puede ser estimado con un estimador plug-in:</p>
<p><span class="math display">\[\hat x_p = \inf\{t:\hat S(t)\leq 1-p\}\]</span></p>
<p>La varianza del estimador anterior se pueden estimar como:</p>
<p><span class="math display">\[\hat V(\hat x_p)=\frac{\hat V[\hat S(\hat x_p)]}{\hat f(\hat x_p)^2}\]</span></p>
<p>donde <span class="math inline">\(\hat f(\hat x_p)\)</span> es un estimador no-paramétrico de <span class="math inline">\(f(\hat x_p)\)</span> (densidad). Por ejemplo, cualquier estimador por kernel de <span class="math inline">\(f\)</span> es una opción válida.</p>
<p><strong>Aproximación de Brookmeyer y Crowley</strong></p>
<p><span class="math display">\[-z_{1-\alpha/2}\leq \frac{\hat S(t)-(1-p)}{\hat V^{1/2}[\hat S(t)]}\leq z_{1-\alpha/2}\]</span></p>
<p>es un intervalo de confianza al <span class="math inline">\(100(1-\alpha)\)</span>% para <span class="math inline">\(x_p\)</span>. Un IC para <span class="math inline">\(x_p\)</span> basado en la transformación log-log es:</p>
<p><span class="math display">\[-z_{1-\alpha/2}\leq \frac{\log(-\log \hat S(t))-\log(-\log(1-p))}{\frac{\hat V^{1/2}(\hat S(t))}{\hat S(t)\log \hat S(t)}}\leq z_{1-\alpha/2}\]</span></p>
<p><em>Nota</em>: caso más usual es <span class="math inline">\(p=1/2\)</span>.</p>
</section>
<section id="estimadores-para-datos-censurados-por-la-derecha-y-truncados-por-la-izquierda" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="estimadores-para-datos-censurados-por-la-derecha-y-truncados-por-la-izquierda"><span class="header-section-number">2.4</span> Estimadores para datos censurados por la derecha y truncados por la izquierda</h2>
<p>Considere para cada individuo:</p>
<ul>
<li><p><span class="math inline">\(L_j\)</span>: edad aleatoria de ingreso del individuo <span class="math inline">\(j\)</span>-ésimo.</p></li>
<li><p><span class="math inline">\(T_j\)</span>: tiempo de ocurrencia del evento o censura para el individuo <span class="math inline">\(j\)</span>-ésimo.</p></li>
</ul>
<p>Sea <span class="math inline">\(t_1&lt;t_2&lt;\cdots &lt;t_D\)</span> los tiempos distintos de ocurrencia de los eventos. Además, siguiendo la notación de las secciones anteriores:</p>
<ul>
<li><p><span class="math inline">\(d_i\)</span>: número de individuos que experimentan el evento o riesgo de interés en tiempo <span class="math inline">\(t_i\)</span> (<span class="math inline">\(i=1,\ldots,D\)</span>)</p></li>
<li><p><span class="math inline">\(Y_i\)</span>: individuos en riesgo al tiempo <span class="math inline">\(t_i\)</span>.</p></li>
</ul>
<p>Con el fin de considerar esquemas de censura/truncamiento más amplios, se tienen las siguientes dos definiciones para la población en riesgo:</p>
<ul>
<li><p><span class="math inline">\(Y_i\)</span>: número de individuos en el estudio en tiempo <span class="math inline">\(0\)</span> y que están en riesgo al momento <span class="math inline">\(t_i\)</span> (esquema sin truncamiento )</p></li>
<li><p><span class="math inline">\(Y_i\)</span>: número de individuos en riesgo al momento <span class="math inline">\(t_i\)</span> tales que (Truncamiento por la izquierda):</p></li>
</ul>
<p><span class="math display">\[L_j&lt;t_i \leq T_j\]</span></p>
<p>Todos los estimadores de <span class="math inline">\(S(t)\)</span> vistos hasta ahora aplican, pero la interpretación debe hacerse con cuidado. Por ejemplo, el estimador de KM se debe interpretar como el estimador de la función de sobrevivencia en tiempo <span class="math inline">\(t\)</span>, pero condicional en <span class="math inline">\(L=\min_j\{L_j\}\)</span>:</p>
<p><span class="math display">\[P[X&gt;t|X\geq L]=\frac{S(t)}{S(L)}\]</span></p>
<p>Por lo tanto el estimador de KM sería:</p>
<p><span class="math display">\[\hat S_L(t)=\prod_{L\leq t_i \leq t}\left[1-\frac{d_i}{Y_i}\right]\qquad t\geq L\]</span></p>
<p>es decir se estaía incluyendo solamente eventos o censuras que estén después de <span class="math inline">\(a\)</span>, donde <span class="math inline">\(a=L\)</span>.</p>
<p><em>Nota</em>: las fórmulas de Nelson-Aalen y Greenwood también se pueden calcular en este contexto.</p>
</section>
<section id="estimadores-para-riesgos-en-competencia" class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="estimadores-para-riesgos-en-competencia"><span class="header-section-number">2.5</span> Estimadores para riesgos en competencia</h2>
<p>Para modelos de riesgos de competencia, el supuesto de independencia entre tiempos de eventos y censuras no necesariamente se puede aplicar. En este caso, definimos tres formas distintas de resumir información:</p>
<p><strong>Estimador de Kaplan-Meier complementario</strong></p>
<p>Si existieran dos riesgos en competencia (A y B) se define el estimador:</p>
<p><span class="math display">\[\hat S_A(t)=KM(\text{ocurrencias de A como eventos, ocurrencias de B como censuras})\]</span></p>
<p>La idea se generaliza muy fácilmente para el caso de más de dos riesgos. Inconveniente: estimador muy crudo para generar interpretaciones apropiadas.</p>
<p><strong>Función acumulada de incidencia</strong></p>
<p>Sea <span class="math inline">\(t_1,\ldots,t_k\)</span> los tiempos distintos en los cuales uno de los riesgos en competencia ocurre. En tiempo <span class="math inline">\(t_i\)</span> definimos lo siguiente:</p>
<ul>
<li><p><span class="math inline">\(Y_i\)</span>: número de sujetos en riesgo al momento <span class="math inline">\(t_i\)</span>.</p></li>
<li><p><span class="math inline">\(r_i\)</span>: número de sujetos que les ocurrió el evento de interés.</p></li>
<li><p><span class="math inline">\(d_i\)</span>: número de sujetos que les ocurrió otro evento que no sea el de interés (sin incluir censuras).</p></li>
</ul>
<p>La función acumulada de incidencia se define:</p>
<span class="math display">\[\begin{align*}
   CI(t)=\begin{cases}
     0 &amp; t\leq t_1\\
     \sum_{t_i\leq t}\underbrace{\left[\prod_{j=1}^{i-1}\frac{1-(d_j+r_j)}{Y_j}\right]}_{\hat S(t_{i-})}\frac{r_i}{Y_i} &amp; t_1\leq t
  \end{cases}
\end{align*}\]</span>
<p>donde <span class="math inline">\(\hat S(t_{i-})\)</span> es el estimador KM evaluado justo antes de <span class="math inline">\(t_i\)</span>.</p>
<p>Interpretación de <span class="math inline">\(CI(t)\)</span>: probabilidad de que el evento de interés ocurra antes de tiempo <span class="math inline">\(t\)</span> y antes de cualquier otro evento en competencia. La varianza de <span class="math inline">\(CI(t)\)</span> es: (fórmula 4.7.2-Klein)</p>
<p><span class="math display">\[V[CI(t)]=\sum_{t_i\leq t}\hat S(t_i)^2\left[(CI(t)-CI(t_i))^2\cdot \frac{r_i+d_i}{Y_i^2}+[1-2(CI(t)-CI(t_i))]\cdot \frac{r_i}{Y_i^2}\right]\]</span></p>
<p>de lo anterior es posible construir un intervalo de confianza al <span class="math inline">\(100(1-\alpha)\)</span>% para la incidencia acumulada:</p>
<p><span class="math display">\[CI(t)\pm z_{1-\alpha/2}V[CI(t)]^{1/2}\]</span></p>
<p><strong>Probabilidad condicional para un riesgo en competencia</strong></p>
<p>Si <span class="math inline">\(CI_k(t)\)</span> es la función acumulada de incidencia para el riesgo <span class="math inline">\(k\)</span>-ésimo y <span class="math inline">\(CI_{k^c}(t)\)</span> es la función acumulada de incidencia para todos los riesgos excepto el <span class="math inline">\(k\)</span>-ésimo. Entonces definimos la probabilidad condicional para el riesgo <span class="math inline">\(k\)</span>-ésimo como:</p>
<p><span class="math display">\[CP_k(t)=\frac{CI_k(t)}{1-CI_{k^c}(t)}\]</span></p>
<p>con varianza:</p>
<p><span class="math display">\[V[CP_k(t)]=\frac{\hat S(t_{-})^2}{[1-CI_{k^c}(t)]^4}\sum_{t_i\leq t}\frac{[1-CI_{k^c}(t_i)]^2r_i+CI_k(t_i)^2d_i}{Y_i^2}\]</span></p>
<p>Interpretación de <span class="math inline">\(CP_k(t)\)</span>: estima la probabilidad condicional de que el evento <span class="math inline">\(k\)</span> ocurre en tiempo <span class="math inline">\(t\)</span> si ninguna de las otras causas de riesgo han ocurrido antes de <span class="math inline">\(t\)</span>.</p>
</section>
<section id="estimación-de-st-para-otros-esquemas-de-censura" class="level2" data-number="2.6">
<h2 data-number="2.6" class="anchored" data-anchor-id="estimación-de-st-para-otros-esquemas-de-censura"><span class="header-section-number">2.6</span> Estimación de <span class="math inline">\(S(t)\)</span> para otros esquemas de censura</h2>
<section id="censura-por-la-izquierda" class="level3" data-number="2.6.1">
<h3 data-number="2.6.1" class="anchored" data-anchor-id="censura-por-la-izquierda"><span class="header-section-number">2.6.1</span> Censura por la izquierda</h3>
<p>En este caso los individuos experimentan el evento antes del periodo de observación, o bien lo experimentan dentro del periodo de observacion.</p>
<p>Solución: redefinir el tiempo al fijar para <span class="math inline">\(\tau&gt;0\)</span> (grande):</p>
<p><span class="math display">\[\tilde t=\tau-t\]</span></p>
<p>y transformar entonces la censura por la izquierda por censura por la derecha. Como estimadores se pueden utilizar KM o Nelson-Aalen con la particularidad de que:</p>
<p><span class="math display">\[P[\tau-X&gt;t]=P[X&lt;t-\tau]\]</span></p>
</section>
<section id="censura-doble" class="level3" data-number="2.6.2">
<h3 data-number="2.6.2" class="anchored" data-anchor-id="censura-doble"><span class="header-section-number">2.6.2</span> Censura doble</h3>
<p>Para estimar <span class="math inline">\(S(t)\)</span> bajo este esquema, usaremos el <em>Proceso o algoritmo de Turnbull</em>:</p>
<p>Suponga una grilla de puntos en el tiempo:</p>
<p><span class="math display">\[0=t_0&lt;t_1&lt;t_2&lt;\cdots&lt;t_m\]</span></p>
<p>y defina:</p>
<ul>
<li><p><span class="math inline">\(d_i\)</span>: número de eventos en tiempo <span class="math inline">\(t_i\)</span> (<span class="math inline">\(d_i\)</span> puede ser 0).</p></li>
<li><p><span class="math inline">\(r_i\)</span>: número de individuos con censura por la derecha en tiempo <span class="math inline">\(t_i\)</span>.</p></li>
<li><p><span class="math inline">\(c_i\)</span>: número de individuos con censura por la izquierda en tiempo <span class="math inline">\(t_i\)</span>.</p></li>
</ul>
<p><strong>Algoritmo</strong></p>
<ul>
<li><p>Paso 0: Produzca un estimador inicial de <span class="math inline">\(S(t)\)</span> en cada <span class="math inline">\(t_j\)</span> llamado <span class="math inline">\(S_0(t_j)\)</span>. Turnbull (1974): tome <span class="math inline">\(S_0(t)=KM(t)\)</span> ignorando la censura por la izquierda.</p></li>
<li><p>Paso <span class="math inline">\(k+1\)</span>:</p>
<ul>
<li>Con <span class="math inline">\(S_k(\cdot)\)</span> calcule, para <span class="math inline">\(j\leq i\)</span>:</li>
</ul></li>
</ul>
<p><span class="math display">\[p_{ij}=P[t_{j-1}&lt;X\leq t_i|X\leq t_i]\approx \frac{S_k(t_{j-1})-S_k(t_j)}{1-S_k(t_i)}\]</span></p>
<ul>
<li>Estime el número de eventos en tiempo <span class="math inline">\(t_i\)</span> como:</li>
</ul>
<p><span class="math display">\[\hat d_i=d_i+\sum_{i=j}^m c_ip_{ij}\]</span></p>
<ul>
<li><p>Calcule el estimador KM con datos censurados por la derecha usando <span class="math inline">\(\hat d_i\)</span> como eventos y <span class="math inline">\(r_i\)</span> como censuras.</p></li>
<li><p>Si <span class="math inline">\(S_{k+1}(t)\)</span> es cercano a <span class="math inline">\(S_k(t)\)</span> para todo <span class="math inline">\(t_i\)</span> entonces el proceso termina.</p></li>
</ul>
</section>
<section id="censura-por-intervalo" class="level3" data-number="2.6.3">
<h3 data-number="2.6.3" class="anchored" data-anchor-id="censura-por-intervalo"><span class="header-section-number">2.6.3</span> Censura por intervalo</h3>
<p>Para este esquema cada individuo tiene un intervalo <span class="math inline">\((L_i,R_i]\)</span> en donde el evento ocurre, pero el tiempo exacto es desconocido (<span class="math inline">\(i=1,\ldots,n\)</span>)</p>
<p>Para estimar la función de sobrevivencia, se utiliza una modificación del algoritmo de Turnbull. Considere una grilla de tiempos <span class="math inline">\(0=\tau_0&lt;\tau_1&lt;\cdots&lt;\tau_m\)</span> que incluyen a <span class="math inline">\(L_i,R_i\)</span> para todo <span class="math inline">\(i=1,\ldots,n\)</span>.</p>
<p>Para la observación <span class="math inline">\(i\)</span>-ésima, defina:</p>
<span class="math display">\[\begin{align*}
\alpha_{ij}=
   \begin{cases}
       1 &amp; \text{si } (\tau_{j-1},\tau_j]\subseteq (L_i,R_i] \\
       0 &amp; \text{otro caso}
   \end{cases}
\end{align*}\]</span>
<p>y dado un estimador inicial de <span class="math inline">\(S(\tau_j)\)</span>:</p>
<ul>
<li>Paso 1: Calcule la probabilidad de que el evento ocurre en tiempo <span class="math inline">\(\tau_j\)</span>:</li>
</ul>
<p><span class="math display">\[p_j=S(\tau_{j-1})-S(\tau_j) \qquad j=1,\ldots,m\]</span></p>
<ul>
<li>Paso 2: Estime el número de eventos al tiempo <span class="math inline">\(\tau_i\)</span>:</li>
</ul>
<p><span class="math display">\[d_i=\sum_{i=1}^n \frac{\alpha_{ij}p_j}{\sum_k \alpha_{ik}p_k}\]</span></p>
<ul>
<li>Paso 3: Calcule una estimación de los sujetos en riesgo al tiempo <span class="math inline">\(\tau_i\)</span>:</li>
</ul>
<p><span class="math display">\[Y_i=\sum_{k=i}^m d_k\]</span></p>
<ul>
<li>Paso 4: Calcule el estimador KM con los datos en los pasos 3 y 4 hasta que haya convergencia de <span class="math inline">\(S\)</span> uniformemente en <span class="math inline">\(\tau_i\)</span>.</li>
</ul>
</section>
</section>
<section id="laboratorio" class="level2" data-number="2.7">
<h2 data-number="2.7" class="anchored" data-anchor-id="laboratorio"><span class="header-section-number">2.7</span> Laboratorio</h2>
<section id="ajustes-básicos" class="level3" data-number="2.7.1">
<h3 data-number="2.7.1" class="anchored" data-anchor-id="ajustes-básicos"><span class="header-section-number">2.7.1</span> Ajustes básicos</h3>
<p>Paquete base de análisis de sobrevivencia: <em>survival</em>. Junto con el paquete KMsurv que contiene los datos del libro de Klein y M.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(KMsurv)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survMisc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'survMisc'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:ggplot2':

    autoplot</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Para ilustrar el cálculo de los estimadores no paramétricos de sobrevivencia con el paquete survival, trabajamos con la base de la sección 1.2 del Klein: Estudio clínico de la droga 6-MP vs un placebo en 42 niños con leucemia aguda. Todos los pacientes presentaban una remisión en el cańcer a nivel de la médula ósea, gracias a un tratamiento con prednisona. A los pacientes se agruparon en pares y se les administró 6-MP o el placebo y se monitoreó hasta que la leucemia regresaba o hasta el fin del estudio (meses). A continuación un vistazo de los datos:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"drug6mp"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(drug6mp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  pair remstat t1 t2 relapse
1    1       1  1 10       1
2    2       2 22  7       1
3    3       2  3 32       0
4    4       2 12 23       1
5    5       2  8 22       1
6    6       1 17  6       1</code></pre>
</div>
</div>
<p>Para una explicación de las variables ver la ayuda de drug6mp o bien la tabla 1.1 en el Klein. Noten que la última columna corresponde al indicador del evento (recaída de los pacientes) para el grupo que se le administró el tratamiento (6-MP).</p>
<p>Como un primer ejercicio, se calcula el estimador de Kaplan-Meier para el grupo tratamiento (6_MP). Para eso primero calculamos el objeto Surv que contiene los tiempos de ocurrencia junto con las censuras:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>surv_6MP <span class="ot">&lt;-</span> <span class="fu">Surv</span>(<span class="at">time =</span> drug6mp<span class="sc">$</span>t2,<span class="at">event =</span> drug6mp<span class="sc">$</span>relapse)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>surv_6MP</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 10   7  32+ 23  22   6  16  34+ 32+ 25+ 11+ 20+ 19+  6  17+ 35+  6  13   9+
[20]  6+ 10+</code></pre>
</div>
</div>
<p>y después calculamos el estimador de Kaplan-Meier:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>KM_6MP <span class="ot">&lt;-</span> <span class="fu">survfit</span>(surv_6MP<span class="sc">~</span><span class="dv">1</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(KM_6MP)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = surv_6MP ~ 1)

 time n.risk n.event survival std.err lower 95% CI upper 95% CI
    6     21       3    0.857  0.0764        0.720        1.000
    7     17       1    0.807  0.0869        0.653        0.996
   10     15       1    0.753  0.0963        0.586        0.968
   13     12       1    0.690  0.1068        0.510        0.935
   16     11       1    0.627  0.1141        0.439        0.896
   22      7       1    0.538  0.1282        0.337        0.858
   23      6       1    0.448  0.1346        0.249        0.807</code></pre>
</div>
</div>
<p>Comparen esta tabla con Tabla 4.1A del Klein. La quinta columna con el error estándar corresponde a <span class="math inline">\(\sigma_S(t)\)</span>. Un gráfico de <span class="math inline">\(\hat S(t)\)</span> es:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(KM_6MP)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="estNP_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Por default, los intervalos de confianza se calculan sobre el logaritmo de <span class="math inline">\(S(t)\)</span>. Para calcular los intervalos con la transformación log-log al 95% de confianza:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>KM_6MP_loglog <span class="ot">&lt;-</span> <span class="fu">survfit</span>(surv_6MP<span class="sc">~</span><span class="dv">1</span>,<span class="at">conf.type=</span><span class="st">'log-log'</span>,)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(KM_6MP_loglog)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = surv_6MP ~ 1, conf.type = "log-log")

 time n.risk n.event survival std.err lower 95% CI upper 95% CI
    6     21       3    0.857  0.0764        0.620        0.952
    7     17       1    0.807  0.0869        0.563        0.923
   10     15       1    0.753  0.0963        0.503        0.889
   13     12       1    0.690  0.1068        0.432        0.849
   16     11       1    0.627  0.1141        0.368        0.805
   22      7       1    0.538  0.1282        0.268        0.747
   23      6       1    0.448  0.1346        0.188        0.680</code></pre>
</div>
</div>
<p>Asimismo se puede calcular bandas de confianza a través del paquete km.ci:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(km.ci)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>bandasEP_KM_6MP <span class="ot">&lt;-</span> <span class="fu">km.ci</span>(KM_6MP,<span class="at">conf.level =</span> <span class="fl">0.95</span>,<span class="at">tl =</span> <span class="cn">NA</span>,<span class="at">tu =</span> <span class="cn">NA</span>,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">method =</span> <span class="st">'epband'</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>bandasHall_KM_6MP <span class="ot">&lt;-</span> <span class="fu">km.ci</span>(KM_6MP,<span class="at">conf.level =</span> <span class="fl">0.95</span>,<span class="at">tl =</span> <span class="cn">NA</span>,<span class="at">tu =</span> <span class="cn">NA</span>,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">method =</span> <span class="st">'hall-wellner'</span>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(bandasEP_KM_6MP,<span class="at">lty =</span> <span class="dv">2</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(bandasHall_KM_6MP,<span class="at">lty =</span> <span class="dv">3</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(KM_6MP_loglog,<span class="at">lty=</span><span class="dv">1</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(KM_6MP_loglog,<span class="at">lty=</span><span class="dv">4</span>,<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">conf.int =</span> T)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>linetype<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="dv">0</span>, .<span class="dv">4</span>, <span class="fu">c</span>(<span class="st">"Kaplan-Meier"</span>, <span class="st">"EP"</span>,<span class="st">"Hall-Wellner"</span>, <span class="st">"Pointwise"</span>),</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">lty=</span>(linetype))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="estNP_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>y también pueden utilizar la función ci del paquete survMisc.</p>
<p>También se puede estimar <span class="math inline">\(S(t)\)</span> a través del estimador de Nelson-Aalen:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>NA_6MP <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">coxph</span>(surv_6MP<span class="sc">~</span><span class="dv">1</span>), <span class="at">type=</span><span class="st">"aalen"</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(NA_6MP)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = coxph(surv_6MP ~ 1), type = "aalen")

 time n.risk n.event survival std.err lower 95% CI upper 95% CI
    6     21       3    0.867  0.0715        0.737        1.000
    7     17       1    0.817  0.0828        0.670        0.997
   10     15       1    0.765  0.0927        0.603        0.970
   13     12       1    0.704  0.1035        0.527        0.939
   16     11       1    0.642  0.1111        0.458        0.902
   22      7       1    0.557  0.1249        0.359        0.864
   23      6       1    0.471  0.1317        0.273        0.815</code></pre>
</div>
</div>
<p>o bien se puede calcular el riesgo acumulado <span class="math inline">\(H\)</span> y su varianza a través de la función sf de survMisc:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>t_6MP <span class="ot">&lt;-</span> <span class="fu">ten</span>(surv_6MP)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>H_6MP <span class="ot">&lt;-</span> <span class="fu">sf</span>(<span class="at">x =</span> t_6MP<span class="sc">$</span>e,<span class="at">n =</span> t_6MP<span class="sc">$</span>n,<span class="at">what =</span> <span class="st">'H'</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>Hv_6MP <span class="ot">&lt;-</span> <span class="fu">sf</span>(<span class="at">x =</span> t_6MP<span class="sc">$</span>e,<span class="at">n =</span> t_6MP<span class="sc">$</span>n,<span class="at">what =</span> <span class="st">'Hv'</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>Tabla4_2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">tiempo=</span>t_6MP<span class="sc">$</span>t,<span class="at">d=</span>t_6MP<span class="sc">$</span>e,H_6MP,Hv_6MP)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>Tabla4_2 <span class="ot">&lt;-</span> Tabla4_2 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(d<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">ErrorS=</span><span class="fu">sqrt</span>(Hv_6MP))</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(Tabla4_2,<span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  tiempo d  H_6MP Hv_6MP ErrorS
1      6 3 0.1429 0.0068 0.0825
2      7 1 0.2017 0.0103 0.1013
3     10 1 0.2683 0.0147 0.1213
4     13 1 0.3517 0.0217 0.1471
5     16 1 0.4426 0.0299 0.1730
6     22 1 0.5854 0.0503 0.2243
7     23 1 0.7521 0.0781 0.2795</code></pre>
</div>
</div>
<p>Comparen este resultado con la Tabla 4.2 del Klein.</p>
<p>Otro aspecto a calcular es el tiempo medio de sobrevivencia de este grupo de pacientes. Para ello usamos la función <em>print</em> del paquete <em>survival</em>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(KM_6MP,<span class="at">print.rmean =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = surv_6MP ~ 1)

      n events rmean* se(rmean) median 0.95LCL 0.95UCL
[1,] 21      9   23.3      2.83     23      16      NA
    * restricted mean with upper limit =  35 </code></pre>
</div>
</div>
<p>y al igual que en el Klein obtenemos un valor estimado de 23.29 días usando corrección de Efron, y un error estándar de 2.83 días. La mediana del tiempo de sobrevivencia usando la transformación log-log se puede obtener también con:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(KM_6MP_loglog,<span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.5</span>,<span class="fl">0.15</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$quantile
50 15 
23  7 

$lower
50 15 
13  6 

$upper
50 15 
NA 13 </code></pre>
</div>
</div>
<p>en donde también calculamos el cuantil 0.15 de la misma distribución junto con sus intervalos de confianza usando la definición de Klein. Note que para el caso de la mediana, la intersección con el límite superior del intervalo de confianza es nula, por eso nos da un NA.</p>
<p>Para ilustrar el esquema de truncamiento por la izquierda y censura por la derecha, usaremos los datos de la sección 1.16 del Klein, en donde se tiene la edad de muerte (en meses) o su salida de 462 ancianos en un centro de retiro en California y además la edad cuando entraron al mismo centro. Los datos deben ser truncados para medir la mortalidad dentro del centro de retiro, y no debido a otras causas. Un vistazo de los datos es el siguiente:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"channing"</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(channing)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  obs death ageentry  age time gender
1   1     1     1042 1172  130      2
2   2     1      921 1040  119      2
3   3     1      885 1003  118      2
4   4     1      901 1018  117      2
5   5     1      808  932  124      2
6   6     1      915 1004   89      2</code></pre>
</div>
</div>
<p>Note que la variable <em>ageentry</em> es la edad de entrada en meses a la casa de retiro y <em>age</em> es la edad de muerte o censura por la derecha. De nuevo el truncamiento por la izquierda es la mejor opción cuando se tiene un subconjunto de edades más limitado como el que se tiene en esta muestra. Los estimadores de Kaplan-Meier condicionados en 68 y 80 años para hombres y mujeres se ilustra a continuación (transformando los datos a datos anuales):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>channing_Years <span class="ot">&lt;-</span> channing <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">ageentry=</span>ageentry<span class="sc">/</span><span class="dv">12</span>,<span class="at">age=</span>age<span class="sc">/</span><span class="dv">12</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">attach</span>(channing_Years)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>KM_Chan_68 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(<span class="at">time =</span> ageentry,<span class="at">time2 =</span> age,<span class="at">event =</span> death,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">type =</span> <span class="st">'counting'</span>)<span class="sc">~</span>gender,<span class="at">start.time=</span><span class="dv">68</span>,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data=</span>channing_Years)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in Surv(time = ageentry, time2 = age, event = death, type =
"counting"): Stop time must be &gt; start time, NA created</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(KM_Chan_68,<span class="at">conf.int =</span> F,<span class="at">col =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>KM_Chan_80 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(<span class="at">time =</span> ageentry,<span class="at">time2 =</span> age,<span class="at">event =</span> death,</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>                           <span class="at">type =</span> <span class="st">'counting'</span>)<span class="sc">~</span>gender,<span class="at">start.time=</span><span class="dv">80</span>,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data=</span>channing_Years)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in Surv(time = ageentry, time2 = age, event = death, type =
"counting"): Stop time must be &gt; start time, NA created</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(KM_Chan_80,<span class="at">conf.int =</span> F,<span class="at">col =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">4</span>))</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="dv">90</span>, <span class="dv">1</span>, <span class="fu">c</span>(<span class="st">"Male-68"</span>, <span class="st">"Female-68"</span>,<span class="st">"Male-80"</span>, <span class="st">"Female-80"</span>), </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">col=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,<span class="at">lty=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="estNP_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<!-- ### Riesgos en competencia -->
<!-- 1384 Pacientes con gammapatía monoclonal de significado incierto (MGUS) a los cuales se les hace un seguimiento hasta la aparición de neoplasia de células plasmáticas (PCM) o la muerte (en meses). Por ejemplo, el estimador KM de la sobrevivencia (riesgo de muerte) de los pacientes clasificado por sexo es: -->
<!-- ```{r} -->
<!-- mfit1 <- survfit(Surv(futime, death) ~ sex, data=mgus2) -->
<!-- plot(mfit1, col=c(1,2), xscale=12, mark.time=FALSE, lwd=2, -->
<!--      xlab="Years post diagnosis", ylab="Survival") -->
<!-- legend("topright", c("female", "male"), col=1:2, lwd=2, bty='n') -->
<!-- ``` -->
<!-- Considere dos riesgos en competencia: PCM y muerte no relacionada a PCM.  -->
<!-- ```{r} -->
<!-- mgus3 <- mgus2 %>% mutate(etime=ifelse(pstat==0, futime,ptime), -->
<!--                           event = ifelse(pstat==0, 2*death, 1)) -->
<!-- mgus3$event <- factor(mgus3$event, 0:2, labels=c("censor", "pcm", "death")) -->

<!-- table(mgus3$event) -->
<!-- ``` -->
<!-- con el cálculo correspondiente de la incidencia cumulada: -->
<!-- ```{r} -->
<!-- mfit2 <- survfit(Surv(etime, event) ~ sex, data=mgus3) -->
<!-- print(mfit2, rmean=240, scale=12) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- plot(mfit2, col=c(1,2,1,2), lty=c(2,2,1,1), -->
<!-- mark.time=FALSE, lwd=2, xscale=12, -->
<!-- xlab="Years post diagnosis", ylab="Probability in State") -->
<!-- legend(240, .6, c("death:female", "death:male", "pcm:female", "pcm:male"), -->
<!-- col=c(1,2,1,2), lty=c(1,1,2,2), lwd=2, bty='n') -->
<!-- ``` -->
<!-- ### Otros esquemas de muestreo -->
<!-- En esta segunda clase, se calculará empíricamente la función de sobrevivencia bajo tres distintos esquemas de muestreo. -->
<!-- #### Censura doble (Censura por derecha y por izquierda) -->
<!-- Vamos a replicar aproximadamente el ejemplo 5.1 del Klein. A continuación la carga de datos: -->
<!-- ```{r} -->
<!-- library(survival) -->
<!-- library(KMsurv) -->
<!-- library(survMisc) -->
<!-- edades <- 10:18 -->
<!-- eventos <- c(4,12,19,24,20,13,3,1,4) -->
<!-- censuras_izq <- c(0,0,0,1,2,3,2,3,1) -->
<!-- censuras_der <- c(0,0,2,15,24,18,14,6,0) -->
<!-- tabla_5_1 <- data.frame(edades,censuras_izq,eventos,censuras_der) -->
<!-- tabla_5_1 -->
<!-- ``` -->
<!-- comparen esta tabla con la Tabla 5.1 del Klein. El ajuste de este tipo de datos se hace con el paquete *survival* con el algoritmo de Turnbull ajustado a través de EM (Método de Esperanza-Maximización). Antes, hay que convertir los datos a intervalos individualizados según el tipo de censura: -->
<!-- ```{r} -->
<!-- censuras_izq_v <- NULL -->
<!-- for(i in 1:dim(tabla_5_1)[1]){ -->
<!--   if(tabla_5_1[i,2]>0){ -->
<!--     censuras_izq_v <- rbind(censuras_izq_v,matrix(rep(c(-Inf,tabla_5_1[i,1]), -->
<!--                                                       each=tabla_5_1[i,2]), -->
<!--                                                   nrow = tabla_5_1[i,2])) -->
<!--     } -->
<!-- } -->
<!-- eventos_v <- NULL -->
<!-- for(i in 1:dim(tabla_5_1)[1]){ -->
<!--   if(tabla_5_1[i,3]>0){ -->
<!--     eventos_v <- rbind(eventos_v,matrix(rep(c(tabla_5_1[i,1],tabla_5_1[i,1]), -->
<!--                                             each=tabla_5_1[i,3]), -->
<!--                                         nrow = tabla_5_1[i,3])) -->
<!--     } -->
<!-- } -->
<!-- censuras_der_v <- NULL -->
<!-- for(i in 1:dim(tabla_5_1)[1]){ -->
<!--   if(tabla_5_1[i,4]>0){ -->
<!--     censuras_der_v <- rbind(censuras_der_v,matrix(rep(c(tabla_5_1[i,1],Inf), -->
<!--                                                       each=tabla_5_1[i,4]), -->
<!--                                                   nrow = tabla_5_1[i,4])) -->
<!--     } -->
<!-- } -->
<!-- datos_5_1 <- rbind(censuras_der_v,censuras_izq_v,eventos_v) -->
<!-- head(datos_5_1) -->
<!-- tail(datos_5_1) -->
<!-- ``` -->
<!-- y ya con los datos convertidos se puede estimar la función de sobrevivencia: -->
<!-- ```{r} -->
<!-- surv_obj_5_1 <- Surv(time = datos_5_1[,1],time2 = datos_5_1[,2], -->
<!--                      type = 'interval2') -->
<!-- S_5_1 <- survfit(surv_obj_5_1~1) -->
<!-- summary(S_5_1) -->
<!-- plot(S_5_1) -->
<!-- ``` -->
<!-- #### Censura por intervalo -->
<!-- En el caso de censura por intervalo, se ilustrará el algoritmo de Turnbull-EM con los datos del ejemplo 5.2. Estos datos consisten en  -->
<!-- la comparación de dos tratamientos de cáncer de mama a nivel de 95 mujeres (Variable *treat*: 1-Radioterapia, 2-Radioterapia+quimioterapia). Durante visitas periodicas, los médicos midieron el deterioro cosmético en el seno de cada mujer bajo los dos tratamientos. Lo único que se guarda en cada caso en el periodo de tiempo en donde el deterioro fue severo o moderado entre dos visitas sucesivas. El tiempo se mide en meses.  -->
<!-- ```{r} -->
<!-- data("bcdeter") -->
<!-- head(bcdeter) -->
<!-- ``` -->
<!-- La estimación de la función de sobrevivencia para el riesgo de deterioro se estima por tipo de tratamiento: -->
<!-- ```{r} -->
<!-- surv_obj_5_2 <- Surv(time = bcdeter$lower,time2 = bcdeter$upper, -->
<!--                      type = 'interval2') -->
<!-- S_5_2 <- survfit(surv_obj_5_2~treat,data = bcdeter) -->
<!-- summary(S_5_2) -->
<!-- ``` -->
<!--  y gráficamente: -->
<!-- ```{r} -->
<!-- plot(S_5_2,col = c(1,2)) -->
<!-- legend(0,0.4,legend = c('T-1','T-2'),col=c(1,2),lty=1) -->
<!-- ``` -->
<!-- #### Estimación de $S(x)$ con un tabla de vida de un cohorte . -->
<!-- A manera de resumen (les recomiendo que estudien esta sección por su propia cuenta, ya que no presenta diferencias sustanciales con respecto al resto del curso), estos son los principales indicadores que se calculan en una tabla de vida de forma no-paramétrica: -->
<!-- - Cohorte: grupo de individuos con un origen en común en cuanto al tiempo en el cual un evento es calculado (por ejemplo, la misma edad al momento de inicial el estudio) -->
<!-- - Se considera intervalos disjuntos $I_j=(a_{j-1},a_j]$, $j=1,\ldots,k+1$ con $a_0=0$ y $a_{k+1}=\infty$, en donde cada individuo del cohorte tendrá el evento de interés. -->
<!-- - Sea $Y_j'$: número de individuos que no han experimentado el evento en el $j$-ésimo intervalo. -->
<!-- - $W_j$: número de individuos del cohorte que no presentan el evento en el intervalo $j$-ésimo (censuras). -->
<!-- - $d_j$: número de individuos del cohorte que presentan el evento en el intervalo $j$-ésimo (eventos). -->
<!-- - La población en riesgo del intervalo $j$-ésimo se estima asumiendo una distribución uniforme de las censuras: -->
<!-- \begin{align*} -->
<!-- Y_j=Y_j'-W_j/2 -->
<!-- \end{align*} -->
<!-- - La función de sobrevivencia estimada es análoga al estimador de Kaplan-Meier: -->
<!-- \begin{align*} -->
<!-- \hat S(a_j)=\prod_{i=1}^j\left(1-d_i/Y_i\right) -->
<!-- \end{align*} -->
<!-- - La densidad estimada en el punto medio del intervalo $j$-ésimo ($a_{mj}=(a_j+a_{j-1})/2$) es: -->
<!-- \begin{align*} -->
<!-- \hat f(a_{mj})=\frac{\hat S(a_{j-1})-\hat S(a_j)}{a_{j-1}-a_j} -->
<!-- \end{align*} -->
<!-- - La tasa de riesgo estimada en el punto medio del intervalo $j$-ésimo: -->
<!-- \begin{align*} -->
<!-- \hat h(a_{mj})&=\frac{\hat f(a_{mj})}{\hat S(a_{mj})}\\ -->
<!-- &=\frac{2\hat f(a_{mj})}{\hat S(a_{j})+\hat S(a_{j-1})} -->
<!-- \end{align*} -->
<!-- usando interpolación lineal para calcular $\hat S(a_{mj})$. -->
<!-- - Las probabilidad condicionales de sobrevivencia en el $j$-ésimo intervalo es: -->
<!-- \begin{align*} -->
<!-- \hat p_j=1-\hat q_j=1-d_j/Y_j -->
<!-- \end{align*} -->
<!-- donde $\hat q_j$ es la probabilidad condicional de ocurrencia del evento en el mismo intervalo. -->
<!-- Vamos a replicar el ejemplo 5.4 en donde se tiene datos de 927 recién nacidos cuyas madres los alimentaron con lactancia materna. La duración de lactancia materna se midió en semanas, y el evento de interés es la interrupción de la lactancia materna. En cada intervalo también hubo salidas del estudio. -->
<!-- Extraemos los datos y hacemos el cálculo de la tabla de sobreviencia del cohorte: -->
<!-- ```{r} -->
<!-- data("bfeed") -->
<!-- library(tidyverse) -->
<!-- head(bfeed) -->
<!-- ninit <- dim(bfeed)[1] -->
<!-- tis <- c(0,2,3,5,7,11,17,25,37,53,NA) -->
<!-- tis_2 <- c(0,2,3,5,7,11,17,25,37,53,Inf) -->
<!-- pretablas <- bfeed %>% dplyr::select(duration,delta) %>% -->
<!--   mutate(intervalo=cut(duration,breaks = tis_2))%>% -->
<!--   group_by(delta,intervalo)%>% -->
<!--   summarise(conteo=n()) -->
<!-- tabla_resumen <- data.frame(intervalos=unique(pretablas$intervalo), -->
<!--                             eventos=pretablas$conteo[pretablas$delta==1], -->
<!--                             censuras=c(pretablas$conteo[pretablas$delta==0], -->
<!--                                        rep(0,3))) -->
<!-- tabla_resumen$Yprima <- 0 -->
<!-- tabla_resumen$Yprima[1] <-ninit -->
<!-- for(i in 2:dim(tabla_resumen)[1]){ -->
<!--   tabla_resumen$Yprima[i] <-tabla_resumen$Yprima[i-1]-tabla_resumen$eventos[i]- -->
<!--     tabla_resumen$censuras[i] -->
<!-- } -->
<!-- ``` -->
<!-- La tabla resultante y el cálculo de la función de sobrevivencia: -->
<!-- ```{r} -->
<!-- show(tabla_resumen) -->
<!-- tabla_vida <- lifetab(tis,ninit, -->
<!--                       nlost = tabla_resumen$censuras, -->
<!--                       nevent = tabla_resumen$eventos) -->
<!-- show(tabla_vida) -->
<!-- ``` -->
<!-- Las columnas de desviaciones estándar de las función de sobrevivencia, tasa de riesgo y función de densidad se calculan según las fórmulas 5.4.5, 5.4.6 y 5.4.7 del Klein. -->


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./Preliminares.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Preliminares</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./PH.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Pruebas de Hipótesis</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>