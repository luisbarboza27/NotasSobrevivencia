<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Análisis de Sobrevivencia - 5&nbsp; Análisis de Diagnósticos en el Modelo de Cox</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./MRP.html" rel="next">
<link href="./RSP.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Análisis de Diagnósticos en el Modelo de Cox</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Análisis de Sobrevivencia</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Introducción</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Preliminares.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Preliminares</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./estNP.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Estimación No-Paramétrica</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PH.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Pruebas de Hipótesis</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./RSP.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Regresión Semiparamétrica con Riesgos Proporcionales</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./DRSP.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Análisis de Diagnósticos en el Modelo de Cox</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./MRP.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Modelos de Regresión Paramétricos</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">Referencias</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#residuos-de-cox-snell" id="toc-residuos-de-cox-snell" class="nav-link active" data-scroll-target="#residuos-de-cox-snell"><span class="toc-section-number">5.1</span>  Residuos de Cox-Snell</a></li>
  <li><a href="#residuos-martingala" id="toc-residuos-martingala" class="nav-link" data-scroll-target="#residuos-martingala"><span class="toc-section-number">5.2</span>  Residuos Martingala</a></li>
  <li><a href="#análisis-descriptivo-del-supuesto-de-riesgos-proporcionales" id="toc-análisis-descriptivo-del-supuesto-de-riesgos-proporcionales" class="nav-link" data-scroll-target="#análisis-descriptivo-del-supuesto-de-riesgos-proporcionales"><span class="toc-section-number">5.3</span>  Análisis descriptivo del Supuesto de Riesgos Proporcionales</a></li>
  <li><a href="#identificación-de-outliers" id="toc-identificación-de-outliers" class="nav-link" data-scroll-target="#identificación-de-outliers"><span class="toc-section-number">5.4</span>  Identificación de Outliers</a></li>
  <li><a href="#gráfico-de-influencia" id="toc-gráfico-de-influencia" class="nav-link" data-scroll-target="#gráfico-de-influencia"><span class="toc-section-number">5.5</span>  Gráfico de Influencia</a></li>
  <li><a href="#laboratorio" id="toc-laboratorio" class="nav-link" data-scroll-target="#laboratorio"><span class="toc-section-number">5.6</span>  Laboratorio</a>
  <ul class="collapse">
  <li><a href="#ejemplo-1" id="toc-ejemplo-1" class="nav-link" data-scroll-target="#ejemplo-1"><span class="toc-section-number">5.6.1</span>  Ejemplo 1</a></li>
  <li><a href="#ejemplo-2" id="toc-ejemplo-2" class="nav-link" data-scroll-target="#ejemplo-2"><span class="toc-section-number">5.6.2</span>  Ejemplo 2</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="DRSP" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Análisis de Diagnósticos en el Modelo de Cox</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="residuos-de-cox-snell" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="residuos-de-cox-snell"><span class="header-section-number">5.1</span> Residuos de Cox-Snell</h2>
<p>Suponga que un modelo de Cox se ha ajustado a los datos <span class="math inline">\((T_j,\delta_j,Z_j)\)</span> para <span class="math inline">\(j=1,\ldots,n\)</span>. Además asuma que las covariables son estáticas (no dependen del tiempo). Debido a que:</p>
<p><span class="math display">\[S(X_j|Z_j)=1-F_T(X_j|Z_j)\sim \text{Unif}(0,1)\]</span></p>
<p>Entonces:</p>
<p><span class="math display">\[U=H(X_j|Z_j)=-\log S(X_j|Z_j)\sim \text{Exp}(1)\]</span> donde <span class="math inline">\(X_j\)</span>: tiempo de ocurrencia del riesgo del individuo <span class="math inline">\(j\)</span>-ésimo. Si <span class="math inline">\(b=(b_1,\ldots,b_p)^T\)</span> es un estimador de <span class="math inline">\(\beta\)</span> entonces los residuos de Cox-Snell se definen como:</p>
<p><span class="math display">\[r_j=\hat H_0(t)\exp\left(\sum_{k=1}^pZ_{jk}b_k\right),\qquad j=1,\ldots,n\]</span> donde <span class="math inline">\(\hat H_0(t)\)</span> es el estimador de Breslow de <span class="math inline">\(H_0(t)\)</span>.</p>
<p>Si el modelo de Cox es correcto entonces <span class="math inline">\(\{r_j\}_{j=1}^n\)</span> es una muestra censurada de <span class="math inline">\(\text{Exp}(1)\)</span>.</p>
<ol type="1">
<li>Calcule el estimador de Nelson-Aalen de <span class="math inline">\(H(t)\)</span> usando la muestra <span class="math inline">\(\{r_t\}\)</span>. Bajo la hipótesis de bondad de ajuste:</li>
</ol>
<p><span class="math display">\[H(t)=t\]</span> 2. Grafique <span class="math inline">\(r_j\)</span> versus <span class="math inline">\(\hat H(r_j)\)</span> para <span class="math inline">\(j=1,\ldots,n\)</span>:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Cox_Snell.png" class="img-fluid figure-img" style="width:70.0%"></p>
<p></p><figcaption class="figure-caption">Residuos de Cox-Snell</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p><strong>Nota</strong>: el estimador de Cox-Snell se puede definir en casos en donde las covariables dependen del tiempo y/o modelos estratificados:</p>
<p><span class="math display">\[r_j=\hat H_0(T_j)\exp\left(\sum_{k=1}^pZ_{jk}(T_j)b_k\right),\qquad j=1,\ldots,n\]</span></p>
</section>
<section id="residuos-martingala" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="residuos-martingala"><span class="header-section-number">5.2</span> Residuos Martingala</h2>
<p><strong>Objetivo</strong>: definir posibles transformaciones sobre las covariables que permitan mejorar la capacidad explicativa de un modelo de Cox.</p>
<p>Suponga que <span class="math inline">\(Z_j(t)\)</span> son covariables del individuo <span class="math inline">\(j\)</span>-ésimo en el tiempo <span class="math inline">\(t\)</span>. Defina:</p>
<p><span class="math display">\[N_j(t)=\begin{cases}
1 &amp; \text{individuo j-esimo ha experimentado el riesgo al tiempo t}\\
0 &amp; \text{si no.}
\end{cases}
\]</span></p>
<p><span class="math display">\[Y_j(t)=\begin{cases}
1 &amp; \text{individuo j-esimo está bajo estudio inmediatamente antes del tiempo t}\\
0 &amp; \text{si no.}
\end{cases}
\]</span></p>
<p>El residuo martingala se define como:</p>
<p><span class="math display">\[\hat M_j=N_j(\infty)-\int_0^\infty Y_j(t)\exp[b^TZ_j(t)]d\hat H_0(t)\]</span></p>
<p>si los datos son censurados por la derecha y las covariables son fijas entonces:</p>
<p><span class="math display">\[\hat M_j=\delta_j-\hat H_0(T_j)\exp\left(\sum_{k=1}^pZ_{jk}b_k\right)=\delta_j-r_j \qquad j=1,\ldots,n\]</span></p>
<p><strong>Propiedades</strong>:</p>
<ul>
<li><p><span class="math inline">\(\sum_{j=1}^n \hat M_j=0\)</span></p></li>
<li><p>Para muestras grandes <span class="math inline">\(\{\hat M_j\}\)</span> son variables independientes con medias 0.</p></li>
<li><p>Si <span class="math inline">\(b=\beta\)</span> y <span class="math inline">\(\hat H=H_0\)</span> (valores reales) entonces <span class="math inline">\(M_j\)</span> es martingala ya que:</p></li>
</ul>
<p><span class="math display">\[\hat M_j=\text{número observado de eventos}-\text{número esperado de eventos bajo el modelo de Cox}\]</span></p>
<p>Entonces:</p>
<p><span class="math display">\[E[\hat M_j|\text{Información hasta tiempo t}]=0\]</span></p>
<p>Por otro lado, con el fin de resolver el objetivo, suponga que la covariable <span class="math inline">\(Z\)</span> se divide en dos partes: <span class="math inline">\(Z^*\)</span> (covariables con forma funcional conocida) y <span class="math inline">\(Z_1\)</span> (covariables sin forma funcional conocida).</p>
<p>Suponga además que <span class="math inline">\(Z_1\)</span> es independiente de <span class="math inline">\(Z^*\)</span>.</p>
<p>Sea <span class="math inline">\(f(Z_1)\)</span> la mejor función de <span class="math inline">\(Z_1\)</span> que explica su efecto en la sobrevivencia a través del modelo de Cox:</p>
<p><span class="math display">\[h(t|Z^*,Z_1)=h_0(t)\exp[\beta^*Z^*]\exp[f(Z_1)]\]</span></p>
<p>Procedimiento para encontrar <span class="math inline">\(f\)</span>:</p>
<ol type="1">
<li><p>Ajuste un modelo de Cox usando <span class="math inline">\(Z^*\)</span> y calcule <span class="math inline">\(\hat M_j\)</span> para <span class="math inline">\(j=1,\ldots,n\)</span></p></li>
<li><p>Grafique</p></li>
</ol>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Martingala.png" class="img-fluid figure-img" style="width:70.0%"></p>
<p></p><figcaption class="figure-caption">Residuos Martingala</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section>
<section id="análisis-descriptivo-del-supuesto-de-riesgos-proporcionales" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="análisis-descriptivo-del-supuesto-de-riesgos-proporcionales"><span class="header-section-number">5.3</span> Análisis descriptivo del Supuesto de Riesgos Proporcionales</h2>
<p>Asuma que <span class="math inline">\(Z=(Z_1^T,Z_2^T)^T\)</span> donde <span class="math inline">\(Z_1\)</span>: covariable a la que se le va a analizar el supuesto de riesgos proporcionales y <span class="math inline">\(Z_2\)</span>: vector de <span class="math inline">\(p-1\)</span> restantes covariables. Asuma que no hay interacción entre <span class="math inline">\(Z_1\)</span> y <span class="math inline">\(Z_2\)</span>.</p>
<p><strong>Primer gráfico</strong></p>
<ul>
<li><p>Separe <span class="math inline">\(Z_1\)</span> en <span class="math inline">\(k\)</span> estratos disjuntos (llámese <span class="math inline">\(G_1,\ldots,G_k\)</span> a los estratos en el caso continuo o bien en el caso discreto los valores de <span class="math inline">\(Z_1\)</span> se pueden etiquetar como <span class="math inline">\(1,\ldots,k\)</span>).</p></li>
<li><p>Estime un modelo de Cox estratificado sobre los niveles de <span class="math inline">\(Z_1\)</span>.</p></li>
<li><p>Sea <span class="math inline">\(\hat H_{g0}\)</span> la tasa acumulada base de riesgo en el estrato <span class="math inline">\(g\)</span>-ésimo. (<span class="math inline">\(\hat H_{g0}(t)\)</span> debe ser proporcional entre distintos valores de <span class="math inline">\(g=1,\ldots,k\)</span>).</p></li>
<li><p>Grafique <span class="math inline">\(t\)</span> versus <span class="math inline">\(\log[\hat H_{g0}(t)]\)</span>. Bajo el supuesto de riesgos proporcionales los gráficos deberían ser lineales.</p></li>
<li><p>Otro gráfico posible es <span class="math inline">\(\log[\hat H_{g0}(t)]-\log[\hat H_{10}(t)]\)</span> versus <span class="math inline">\(t\)</span>. En este caso cada gráfico debería ser aproximadamente constante bajo el mismo supuesto.</p></li>
</ul>
<p>Inconveniente: los gráficos no dan información detallada del tipo de desviación que tuvo una covariable con respecto al supuesto de riesgos proporcionales.</p>
<p><strong>Segundo gráfico (Gráfico de Andersen)</strong></p>
<ul>
<li>Grafique <span class="math inline">\(\hat H_{g0}(t)\)</span> versus <span class="math inline">\(\hat H_{10}(t)\)</span> para <span class="math inline">\(g=2,\ldots,k\)</span>. Bajo el supuesto de riesgos proporcionales, las curvas deben ser líneas rectas a través del origen.</li>
</ul>
<p>Si <span class="math inline">\(H_{g0}(t)=e^{\gamma_g}H_{10}(t)\)</span> entonces la pendiente de la curva es un estimador de <span class="math inline">\(e^{\gamma_g}\)</span>.</p>
<p>Inconveniente: la varianza de <span class="math inline">\(\hat H_{g0}(t)\)</span> depende de <span class="math inline">\(t\)</span>, por lo tanto los tres gráficos deben ser interpretados con cuidado.</p>
<p><strong>Tercer gráfico (Gráfico de Arjas)</strong></p>
<p>Suponga que un modelo de Cox ha sido ajustado con un vector <span class="math inline">\(Z^*\)</span> de covariables (de tamaño <span class="math inline">\(p\)</span>) y se quiere comprobar si una nueva covariable <span class="math inline">\(Z\)</span>:</p>
<ul>
<li><p>Debe ser incluida en el modelo.</p></li>
<li><p><span class="math inline">\(Z\)</span> tiene riesgos proporcionales después de incluir <span class="math inline">\(Z^*\)</span>.</p></li>
</ul>
<p>Sea <span class="math inline">\(\hat H(t|Z_j^*)\)</span> la tasa de riesgo del modelo ajustado para el individuo <span class="math inline">\(j\)</span>-ésimo. Bajo una agrupación de la covariable <span class="math inline">\(Z\)</span> en <span class="math inline">\(k\)</span> estratos se calcula para cada uno de ellos:</p>
<p><span class="math display">\[TOT_g(t_i)=\sum_{Z_{1j}=g}\hat H(\min(t_i,T_j)|Z_j^*)\]</span> el cual es el</p>
<p>tiempo total esperado a prueba. El número observado de eventos que han ocurrido hasta tiempo <span class="math inline">\(t_i\)</span> es:</p>
<p><span class="math display">\[N_{g}(t_i)=\sum_{Z_{1j}=g}\delta_j1(T_j\leq t_i)\]</span></p>
<p>Si la covariable <span class="math inline">\(Z\)</span> no necesita estar en el modelo entonces <span class="math inline">\(N_g(t_i)-TOT_g(t_i)\)</span> es una martingala, para cada <span class="math inline">\(g\)</span>.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Arjas.png" class="img-fluid figure-img" style="width:70.0%"></p>
<p></p><figcaption class="figure-caption">Gráfico de Arjas</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Si la covariable <span class="math inline">\(Z\)</span> debe ser incluida en el modelo entonces:</p>
<p><span class="math display">\[h(t|Z=g,Z^*)=h_0(t)\exp(\gamma_g)\exp(\beta^TZ^*)\]</span></p>
<p>y las curvas son aproximadamente lineales con pendientes distintas de 1. Si <span class="math inline">\(Z\)</span> no satisface el principio de riesgos proporcionales entonces las curvas no son lineales y su pendiente difiere de 1.</p>
<p><strong>Cuarto gráfico (Residuos score)</strong></p>
<p>Se ajusta un modelo de Cox sobre las <span class="math inline">\(p\)</span> covariables. Sea <span class="math inline">\(b\)</span> el estimador de verosimilitud parcial de <span class="math inline">\(\beta\)</span> y <span class="math inline">\(\hat H_0(t)\)</span> la tasa de riesgo base estimada. Considere:</p>
<ul>
<li><p><span class="math inline">\(N_j(t)\)</span>: indicadora de que el <span class="math inline">\(j\)</span>-ésimo paciente/sujeto ha experimentado el riesgo en tiempo <span class="math inline">\(t\)</span></p></li>
<li><p><span class="math inline">\(Y_j(t)\)</span>: indicadora de que el <span class="math inline">\(j\)</span>-ésimo sujeto está bajo estudio justo antes del tiempo <span class="math inline">\(t\)</span>.</p></li>
</ul>
<p>Para la <span class="math inline">\(k\)</span>-ésima covariable defina:</p>
<p><span class="math display">\[\bar Z_k(t)=\frac{\sum_{j=1}^n Y_j(t)Z_{jk}(t)\exp[b^TZ_j(t)]}{\sum_{j=1}^n Y_j(t)\exp[b^TZ_j(t)]}\]</span></p>
<p>el cual es un promedio ponderado de <span class="math inline">\(Z_{jk}(t)\)</span> y sea <span class="math inline">\(\hat M_j(t)\)</span> el residuo martingala al tiempo <span class="math inline">\(t\)</span> para el individuo <span class="math inline">\(j\)</span>-ésimo:</p>
<p><span class="math display">\[\hat M_j(t)=N_j(t)-\int_0^tY_j(u)\exp[b^TZ_j(u)]d\hat H_0(u)\qquad j=1,\ldots,n\]</span></p>
<p>El residuo score para la <span class="math inline">\(k\)</span>-ésima covariable y el individuo <span class="math inline">\(j\)</span>-ésimo se define como:</p>
<p><span class="math display">\[S_{jk}(t)=\int_0^t[Z_{jk}(u)-\bar Z_k(u)]d\hat M_j(u)\]</span></p>
<p>El proceso score para la <span class="math inline">\(k\)</span>-ésima covariable es:</p>
<p><span class="math display">\[U_k(t)=\sum_{j=1}^n S_{jk}(t)\]</span> En el caso de que todas las covariables son fijas en tiempo 0 entonces:</p>
<p><span class="math display">\[U_k(t)=\sum_{\text{muertes}\leq t}\underbrace{[Z_{jk}-\bar Z_k(T_j)]}_\text{residuos de Schoenfeld}\]</span></p>
<p>Nota: el proceso score <span class="math inline">\(U_k(t)\)</span> es la primera derivada parcial de la verosimilitud parcial del modelo de Cox ajustado con información hasta tiempo <span class="math inline">\(t\)</span>. Además:</p>
<p><span class="math display">\[U_k(0)=0 \qquad \text{y} \qquad U_k(\infty)=0\]</span></p>
<p>dado que <span class="math inline">\(b\)</span> resuelve la ecuación score. Además bajo la hipótesis de que el modelo ajusta bien entonces:</p>
<p><span class="math display">\[W_k(t)=U_k(t)\cdot \text{Error estándar}(b_k)\]</span></p>
<p>y la expresión anterior converge a un puente browniano que se anula en 0 y en <span class="math inline">\(\infty\)</span>, siempre y cuando <span class="math inline">\(\text{Cov}(b_k,b_{k'})=0\)</span> para <span class="math inline">\(k\neq k'\)</span>.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Schoenfeld.png" class="img-fluid figure-img" style="width:70.0%"></p>
<p></p><figcaption class="figure-caption">Residuos de Schoenfeld</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>En el gráfico anterior, en el cuadrante superior se nota que existe evidencia en contra de <span class="math inline">\(H_0\)</span> ya que <span class="math inline">\(W_k(t)\)</span> es superior al cuantil superior bajo <span class="math inline">\(H_0\)</span>, es decir el supuesto de riesgos proporcionales para <span class="math inline">\(Z_k\)</span> no es cierto.</p>
</section>
<section id="identificación-de-outliers" class="level2" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="identificación-de-outliers"><span class="header-section-number">5.4</span> Identificación de Outliers</h2>
<p>Con el fin de detectar outliers podemos usar un gráfico con los residuos martingala (<span class="math inline">\(\hat M_j\)</span>) vs <span class="math inline">\(j\)</span>.</p>
<p><em>Principal problema:</em> valor máximo del residuo=1 y el valor mínimo del residuo=<span class="math inline">\(-\infty\)</span>. Por lo tanto los residuos martingala son muy asimétricos.</p>
<p><em>Solución</em>: modificar <span class="math inline">\(\hat M_j\)</span> a través del residuo de devianza:</p>
<p><span class="math display">\[D_j=\text{signo}[\hat M_j]\cdot \left\{-2\left[\hat M_j+\delta_j\log(\delta_j-\hat M_j)\right] \right\}^{1/2}\]</span></p>
<ul>
<li><p>Si <span class="math inline">\(\hat M_j=0\)</span> entonces <span class="math inline">\(D_j=0\)</span></p></li>
<li><p>Si <span class="math inline">\(\hat M_j\longrightarrow 1\)</span> entonces <span class="math inline">\(D_j\longrightarrow \infty\)</span></p></li>
<li><p>Si <span class="math inline">\(\hat M_j\longrightarrow -\infty\)</span> entonces <span class="math inline">\(D_j\longrightarrow -\infty\)</span> (a una menor tasa).</p></li>
</ul>
<p>Gráfico sugerido (misma interpretación de un gráfico de residuos en regresión):</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/devianza.png" class="img-fluid figure-img" style="width:70.0%"></p>
<p></p><figcaption class="figure-caption">Residuos de devianza</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>donde el score de riesgo es:</p>
<p><span class="math display">\[\text{Score de riesgo}_j=\sum_{k=1}^p b_kZ_{jk}\]</span> La identificación de outliers se puede realizar bajo el supuesto de normalidad en los residuos <span class="math inline">\(N(0,1)\)</span>.</p>
</section>
<section id="gráfico-de-influencia" class="level2" data-number="5.5">
<h2 data-number="5.5" class="anchored" data-anchor-id="gráfico-de-influencia"><span class="header-section-number">5.5</span> Gráfico de Influencia</h2>
<p>Con el fin de verificar el grado de influencia de cada observación en los estimadores de <span class="math inline">\(\beta\)</span>, se compara <span class="math inline">\(b\)</span> con <span class="math inline">\(b_{(j)}\)</span>: estimador de <span class="math inline">\(\beta\)</span> quitando la <span class="math inline">\(j\)</span>-ésima observación. Esto se hace simplemente a través de la diferencia <span class="math inline">\(b-b_{(j)}\)</span>, en el sentido de que si <span class="math inline">\(b-b_{(j)}\)</span> es pequeño, entonces la observación tiene poca influencia.</p>
<p><em>Problema</em>: el procedimiento anterior implica realizar <span class="math inline">\(n+1\)</span> regresiones de Cox.</p>
<p><em>Solución</em>: usar una aproximación para no tener que calcular todas las regresiones:</p>
<p>Sea <span class="math inline">\(S_{jk}=S_{jk}(\infty)\)</span> (residuo score). Si todas las covariables son fijas en tiempo 0:</p>
<p><span class="math display">\[S_{jk}=\underbrace{\delta_j[Z_{jk}-\bar Z_k(T_j)]}_{\text{Residuo parcial de Schoenfeld}}-\sum_{t_b\leq T_j}[Z_{jk}-\bar Z_k(T_b)]\exp(b^TZ_j)\cdot [\hat H_0(t_b)-\hat H_0(t_{b-1})]\]</span></p>
<p>para <span class="math inline">\(j=1,\ldots,n\)</span> y <span class="math inline">\(k=1,\ldots,p\)</span>.</p>
<p>Se puede comprobar que <span class="math inline">\(b-b_{(j)}\approx \Delta_j\)</span> donde:</p>
<p><span class="math display">\[\Delta_j=I(b)^{-1}(S_{j1},\ldots,S_{jp})^T\]</span></p>
<p>donde <span class="math inline">\(I(b)\)</span> es la información de Fisher observada.</p>
<p>Gráficos:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/influencia.png" class="img-fluid figure-img" style="width:70.0%"></p>
<p></p><figcaption class="figure-caption">Gráficos de Influencia</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>en donde el gráfico de la derecha muestra el nivel de influencia de las observaciones sobre la <span class="math inline">\(k\)</span>-ésima covariable.</p>
</section>
<section id="laboratorio" class="level2" data-number="5.6">
<h2 data-number="5.6" class="anchored" data-anchor-id="laboratorio"><span class="header-section-number">5.6</span> Laboratorio</h2>
<section id="ejemplo-1" class="level3" data-number="5.6.1">
<h3 data-number="5.6.1" class="anchored" data-anchor-id="ejemplo-1"><span class="header-section-number">5.6.1</span> Ejemplo 1</h3>
<p>En este ejemplo retomamos los datos de pacientes que han tenido un transplante de médula ósea y se analiza el riesgo de muerte o reaparición de la leucemia. Cargamos datos y paquetes:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survMisc)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(KMsurv)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survminer)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(bmt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Ajustamos un modelo de Cox con las siguientes covariables:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>bmt <span class="ot">&lt;-</span> bmt <span class="sc">%&gt;%</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">waiting=</span>z7<span class="sc">/</span><span class="dv">30-9</span>,<span class="at">FAB=</span><span class="fu">factor</span>(z8),</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">MTX=</span><span class="fu">factor</span>(z10),<span class="at">SXPa=</span><span class="fu">factor</span>(z3),</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">SXDo=</span><span class="fu">factor</span>(z4),<span class="at">CMVPa=</span><span class="fu">factor</span>(z5),</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a> <span class="at">CMVDo=</span><span class="fu">factor</span>(z6),<span class="at">AgePa=</span>z1<span class="dv">-28</span>,<span class="at">AgeDo=</span>z2<span class="dv">-28</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>                      <span class="at">group=</span><span class="fu">factor</span>(group))</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>bmt_2 <span class="ot">&lt;-</span> bmt <span class="sc">%&gt;%</span> <span class="fu">select</span>(t2,d3,group,waiting,FAB,MTX,AgePa,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>                        AgeDo)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>modelo1 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(<span class="at">time=</span>t2, <span class="at">event=</span>d3)<span class="sc">~</span>AgePa<span class="sc">*</span>AgeDo<span class="sc">+</span>group<span class="sc">+</span>FAB<span class="sc">+</span>waiting<span class="sc">+</span>MTX,<span class="at">data =</span> bmt_2)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modelo1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(time = t2, event = d3) ~ AgePa * AgeDo + 
    group + FAB + waiting + MTX, data = bmt_2)

  n= 137, number of events= 83 

                  coef  exp(coef)   se(coef)      z Pr(&gt;|z|)   
AgePa        0.0027997  1.0028036  0.0200198  0.140  0.88878   
AgeDo        0.0036966  1.0037034  0.0182119  0.203  0.83915   
group2      -1.0737773  0.3417153  0.3710846 -2.894  0.00381 **
group3      -0.3860071  0.6797657  0.3725912 -1.036  0.30020   
FAB1         0.8369481  2.3093085  0.2796202  2.993  0.00276 **
waiting     -0.0077053  0.9923243  0.0112797 -0.683  0.49454   
MTX1         0.3042036  1.3555451  0.2529846  1.202  0.22919   
AgePa:AgeDo  0.0030658  1.0030705  0.0009537  3.215  0.00131 **
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

            exp(coef) exp(-coef) lower .95 upper .95
AgePa          1.0028     0.9972    0.9642    1.0429
AgeDo          1.0037     0.9963    0.9685    1.0402
group2         0.3417     2.9264    0.1651    0.7072
group3         0.6798     1.4711    0.3275    1.4109
FAB1           2.3093     0.4330    1.3350    3.9948
waiting        0.9923     1.0077    0.9706    1.0145
MTX1           1.3555     0.7377    0.8256    2.2256
AgePa:AgeDo    1.0031     0.9969    1.0012    1.0049

Concordance= 0.681  (se = 0.031 )
Likelihood ratio test= 34.71  on 8 df,   p=3e-05
Wald test            = 35.61  on 8 df,   p=2e-05
Score (logrank) test = 38.69  on 8 df,   p=6e-06</code></pre>
</div>
</div>
<p>Antes de calcular los residuos de Cox-Snell calculamos los residuos Martingala, y después los obtenemos por diferencia con respecto a los eventos observados:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>bmt_2<span class="sc">$</span>rMart <span class="ot">&lt;-</span> <span class="fu">residuals</span>(modelo1,<span class="at">type =</span> <span class="st">'martingale'</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>bmt_2<span class="sc">$</span>rCox <span class="ot">&lt;-</span> bmt<span class="sc">$</span>d3<span class="sc">-</span>bmt_2<span class="sc">$</span>rMart</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Ahora calculamos el estimador de Nelson-Aalen usando como tiempos los residuos de Cox-Snell:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>modelo1_CoxSnell <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(rCox,d3)<span class="sc">~</span><span class="dv">1</span>,<span class="at">data =</span> bmt_2,<span class="at">ties =</span> <span class="st">'breslow'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>y calculamos la tasa acumulada:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>H0_modelo1_CS <span class="ot">&lt;-</span> <span class="fu">basehaz</span>(modelo1_CoxSnell,<span class="at">centered =</span> <span class="cn">FALSE</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(H0_modelo1_CS<span class="sc">$</span>time,H0_modelo1_CS<span class="sc">$</span>hazard)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>,<span class="at">b=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="DRSP_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>de donde se puede concluir que el ajuste no es malo. Anteriormente habíamos puesto en duda el supuesto de riesgos proporcionales en la variable MTX. Hacemos el gráfico para los dos niveles de la variable MTX y los comparamos:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>modelo1_CoxSnell_MTX1 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(rCox,d3)<span class="sc">~</span><span class="dv">1</span>,<span class="at">data =</span> <span class="fu">subset</span>(bmt_2,MTX<span class="sc">==</span><span class="dv">1</span>),<span class="at">ties =</span> <span class="st">'breslow'</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>modelo1_CoxSnell_MTX0 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(rCox,d3)<span class="sc">~</span><span class="dv">1</span>,<span class="at">data =</span> <span class="fu">subset</span>(bmt_2,MTX<span class="sc">==</span><span class="dv">0</span>),<span class="at">ties =</span> <span class="st">'breslow'</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>H0_modelo1_CS_MTX1 <span class="ot">&lt;-</span> <span class="fu">basehaz</span>(modelo1_CoxSnell_MTX1,<span class="at">centered =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>H0_modelo1_CS_MTX0 <span class="ot">&lt;-</span> <span class="fu">basehaz</span>(modelo1_CoxSnell_MTX0,<span class="at">centered =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(H0_modelo1_CS_MTX0<span class="sc">$</span>time,H0_modelo1_CS_MTX0<span class="sc">$</span>hazard,<span class="at">type=</span><span class="st">'l'</span>,<span class="at">xlab=</span><span class="st">'Tiempo'</span>,<span class="at">ylab=</span><span class="st">'H0'</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(H0_modelo1_CS_MTX1<span class="sc">$</span>time,H0_modelo1_CS_MTX1<span class="sc">$</span>hazard,<span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>,<span class="at">b=</span><span class="dv">1</span>)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x =</span> <span class="dv">0</span>,<span class="at">y =</span> <span class="dv">3</span>,<span class="at">legend =</span> <span class="fu">c</span>(<span class="st">'MTX=0'</span>,<span class="st">'MTX=1'</span>),<span class="at">lty=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="DRSP_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>A partir de este gráfico vemos que el supuesto de riesgos proporcionales no es tan evidente para la covariable MTX. Una posible forma de solucionarlo es a través de un modelo estratificado. Ejercicio: Repetir el procedimiento anterior con el modelo estratificado y comparar con la figura 11.3 del Klein.</p>
<p>Otra posible forma de verificar gráficamente el supuesto de riesgos proporcionales es a través del proceso score, el cual es calculado usando los residuos de Schoenfeld sobre los riesgos observados:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>rSchoen <span class="ot">&lt;-</span> <span class="fu">residuals</span>(modelo1,<span class="at">type =</span> <span class="st">'schoenfeld'</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>muertes <span class="ot">&lt;-</span> bmt_2 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(d3<span class="sc">==</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rSchoen_MTX=</span>rSchoen[,<span class="dv">7</span>],<span class="at">rSchoen_wait=</span>rSchoen[,<span class="dv">6</span>])<span class="sc">%&gt;%</span> </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(t2)<span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Uk_MTX=</span><span class="fu">cumsum</span>(rSchoen_MTX),<span class="at">Uk_wait=</span><span class="fu">cumsum</span>(rSchoen_wait))</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>resumen_m1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(modelo1)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(muertes<span class="sc">$</span>t2,resumen_m1<span class="sc">$</span>coefficients[<span class="dv">7</span>,<span class="dv">3</span>]<span class="sc">*</span>muertes<span class="sc">$</span>Uk_MTX,</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">type=</span><span class="st">'l'</span>,<span class="at">xlab=</span><span class="st">'Tiempo'</span>,<span class="at">ylab=</span><span class="st">'Score Estandarizado'</span>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.3581</span>,<span class="fl">1.3581</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="DRSP_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(muertes<span class="sc">$</span>t2,resumen_m1<span class="sc">$</span>coefficients[<span class="dv">6</span>,<span class="dv">3</span>]<span class="sc">*</span>muertes<span class="sc">$</span>Uk_wait,</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">type=</span><span class="st">'l'</span>,<span class="at">xlab=</span><span class="st">'Tiempo'</span>,<span class="at">ylab=</span><span class="st">'Score Estandarizado'</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.3581</span>,<span class="fl">1.3581</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="DRSP_files/figure-html/unnamed-chunk-14-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>En ambos casos no se sobrepasa los umbrales de confianza de un puente Browniano al 95%, pero hay más evidencia (aunque muy poca) de que la variable MTX no satisface el supuesto de riesgos proporcionales.</p>
</section>
<section id="ejemplo-2" class="level3" data-number="5.6.2">
<h3 data-number="5.6.2" class="anchored" data-anchor-id="ejemplo-2"><span class="header-section-number">5.6.2</span> Ejemplo 2</h3>
<p>El siguiente ejemplo es de 43 pacientes que recibieron un transplante de médula ósea que tenían la enfermedad de Hodgkin (HOD) o el linfoma no-Hodgkin (NHL) (dtype) y se le suministró dos tipos distintos de transplantes (gtype: Allo, Auto). Dos covariables adicionales son el score de Karnofsky (score) y el tiempo de espera desde el diagnóstico hasta el transplante (wtime). Carga de datos:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(hodg)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(hodg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  gtype dtype time delta score wtime
1     1     1   28     1    90    24
2     1     1   32     1    30     7
3     1     1   49     1    40     8
4     1     1   84     1    60    10
5     1     1  357     1    70    42
6     1     1  933     0    90     9</code></pre>
</div>
</div>
<p>Ahora se determinará la mejor transformación de la variable wtime para el análisis a través de los residuos martingala del modelo reducido sin la variable wtime:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>hodg <span class="ot">&lt;-</span> hodg <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">gtype=</span><span class="fu">factor</span>(gtype),<span class="at">dtype=</span><span class="fu">factor</span>(dtype))</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>modelo2_ww <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time,delta)<span class="sc">~</span>gtype<span class="sc">*</span>dtype<span class="sc">+</span>score,<span class="at">data =</span> hodg)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>residuos_mart_w <span class="ot">&lt;-</span> <span class="fu">residuals</span>(modelo2_ww,<span class="at">type =</span> <span class="st">'martingale'</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>datos_mart <span class="ot">&lt;-</span> hodg <span class="sc">%&gt;%</span> <span class="fu">select</span>(wtime) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">rMart=</span>residuos_mart_w)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>grafico_mart <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> datos_mart,<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x=</span>wtime,<span class="at">y =</span> rMart))<span class="sc">+</span><span class="fu">geom_point</span>()<span class="sc">+</span><span class="fu">geom_smooth</span>()</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>grafico_mart</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using method = 'loess' and formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<p><img src="DRSP_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>En donde se puede observar que hay un comportamiento muy diferente en los residuos martingala antes y después de 75 meses. Una posible solución es usar una indicadora a los 75 meses. Usando las técnicas de discretización de variables que vimos en el capítulo 8 (prueba de Contal-O’Quigley):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>modelo2 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time,delta)<span class="sc">~</span>gtype<span class="sc">*</span>dtype<span class="sc">+</span>score<span class="sc">+</span>wtime,<span class="at">data =</span> hodg)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>Contal_modelo2 <span class="ot">&lt;-</span> <span class="fu">cutp</span>(modelo2)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>Contal_modelo2<span class="sc">$</span>wtime[<span class="dv">1</span>,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   wtime        U         Q         p
1:    84 3.206373 0.6813505 0.7420152</code></pre>
</div>
</div>
<p>Por lo tanto se selecciona un corte de 84 meses para la definición de la indicadora. Definimos la variable indicadora:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>hodg <span class="ot">&lt;-</span> hodg <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">i_wtime=</span><span class="fu">ifelse</span>(wtime<span class="sc">&gt;=</span><span class="dv">84</span>,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">contrasts</span>(hodg<span class="sc">$</span>gtype) <span class="ot">&lt;-</span> <span class="fu">contr.treatment</span>(<span class="at">n =</span> <span class="dv">2</span>,<span class="at">base =</span> <span class="dv">2</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="fu">contrasts</span>(hodg<span class="sc">$</span>dtype)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  2
1 0
2 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>modelo2_wi <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time,delta)<span class="sc">~</span>gtype<span class="sc">*</span>dtype<span class="sc">+</span>score<span class="sc">+</span>i_wtime,<span class="at">data =</span> hodg)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modelo2_wi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(time, delta) ~ gtype * dtype + score + i_wtime, 
    data = hodg)

  n= 43, number of events= 26 

                  coef exp(coef) se(coef)      z Pr(&gt;|z|)    
gtype1        -0.66509   0.51423  0.59432 -1.119   0.2631    
dtype2         0.26048   1.29756  0.55547  0.469   0.6391    
score         -0.05504   0.94644  0.01234 -4.459 8.23e-06 ***
i_wtime       -2.05982   0.12748  1.05066 -1.961   0.0499 *  
gtype1:dtype2  2.06684   7.89983  0.92577  2.233   0.0256 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

              exp(coef) exp(-coef) lower .95 upper .95
gtype1           0.5142     1.9447   0.16042    1.6483
dtype2           1.2976     0.7707   0.43683    3.8543
score            0.9464     1.0566   0.92382    0.9696
i_wtime          0.1275     7.8446   0.01626    0.9994
gtype1:dtype2    7.8998     0.1266   1.28705   48.4885

Concordance= 0.796  (se = 0.05 )
Likelihood ratio test= 35.48  on 5 df,   p=1e-06
Wald test            = 28.8  on 5 df,   p=3e-05
Score (logrank) test = 40.09  on 5 df,   p=1e-07</code></pre>
</div>
</div>
<p>En este caso graficamos los residuos de devianza vs los scores de riesgo:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggcoxdiagnostics</span>(modelo2_wi,<span class="at">type =</span> <span class="st">'deviance'</span>,<span class="at">ggtheme =</span> <span class="fu">theme_bw</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: `gather_()` was deprecated in tidyr 1.2.0.
ℹ Please use `gather()` instead.
ℹ The deprecated feature was likely used in the survminer package.
  Please report the issue at &lt;]8;;https://github.com/kassambara/survminer/issueshttps://github.com/kassambara/survminer/issues]8;;&gt;.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<p><img src="DRSP_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>donde podemos observar que hay un par de individuos con valores relativamente altos en su residuos de devianza:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>hodg <span class="ot">&lt;-</span> hodg <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">rDev=</span><span class="fu">residuals</span>(modelo2_wi,<span class="at">type =</span> <span class="st">'deviance'</span>))</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>mayores_dev <span class="ot">&lt;-</span> hodg <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(rDev))</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>mayores_dev[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  gtype dtype time delta score wtime i_wtime    rDev
1     1     1   28     1    90    24       0 2.80429
2     2     2   30     1    90    73       0 2.29525</code></pre>
</div>
</div>
<p>Noten que los dos individuos fallecieron al mes aproximadamente, pero sus scores de riesgo eran bajos, es decir se esperaba que los dos sobrevivieran más.</p>
<p>Ahora graficamos los estadísticos de influencia de las observaciones:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggcoxdiagnostics</span>(modelo2_wi,<span class="at">type =</span> <span class="st">'dfbetas'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: contrasts dropped from factor gtype</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<p><img src="DRSP_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>influence_m <span class="ot">&lt;-</span> <span class="fu">residuals</span>(modelo2_wi,<span class="at">type =</span> <span class="st">'dfbetas'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: contrasts dropped from factor gtype</code></pre>
</div>
</div>
<p>Note que el individuo con mayor influencia en la estimación del score es el número 1:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">which.max</span>(influence_m[,<span class="dv">3</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1 
1 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>hodg[<span class="fu">which.max</span>(<span class="fu">abs</span>(influence_m[,<span class="dv">3</span>])),]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  gtype dtype time delta score wtime i_wtime    rDev
1     1     1   28     1    90    24       0 2.80429</code></pre>
</div>
</div>
<p>y es un individuo con un score relativamente alto (indicador de buen estado físico) pero murió en un momento muy temprano (1 mes aproximadamente). Este individuo es el mismo con un residuo de devianza alto.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./RSP.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Regresión Semiparamétrica con Riesgos Proporcionales</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./MRP.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Modelos de Regresión Paramétricos</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>