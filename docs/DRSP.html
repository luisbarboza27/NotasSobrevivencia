<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Análisis de Sobrevivencia - 5&nbsp; Análisis de Diagnósticos en el Modelo de Cox</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./references.html" rel="next">
<link href="./RSP.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Análisis de Diagnósticos en el Modelo de Cox</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Análisis de Sobrevivencia</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Introducción</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Preliminares.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Preliminares</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./estNP.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Estimación No-Paramétrica</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PH.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Pruebas de Hipótesis</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./RSP.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Regresión Semiparamétrica con Riesgos Proporcionales</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./DRSP.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Análisis de Diagnósticos en el Modelo de Cox</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">Referencias</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#residuos-de-cox-snell" id="toc-residuos-de-cox-snell" class="nav-link active" data-scroll-target="#residuos-de-cox-snell"><span class="toc-section-number">5.1</span>  Residuos de Cox-Snell</a></li>
  <li><a href="#residuos-martingala" id="toc-residuos-martingala" class="nav-link" data-scroll-target="#residuos-martingala"><span class="toc-section-number">5.2</span>  Residuos Martingala</a></li>
  <li><a href="#análisis-descriptivo-del-supuesto-de-riesgos-proporcionales" id="toc-análisis-descriptivo-del-supuesto-de-riesgos-proporcionales" class="nav-link" data-scroll-target="#análisis-descriptivo-del-supuesto-de-riesgos-proporcionales"><span class="toc-section-number">5.3</span>  Análisis descriptivo del Supuesto de Riesgos Proporcionales</a></li>
  <li><a href="#identificación-de-outliers" id="toc-identificación-de-outliers" class="nav-link" data-scroll-target="#identificación-de-outliers"><span class="toc-section-number">5.4</span>  Identificación de Outliers</a></li>
  <li><a href="#gráfico-de-influencia" id="toc-gráfico-de-influencia" class="nav-link" data-scroll-target="#gráfico-de-influencia"><span class="toc-section-number">5.5</span>  Gráfico de Influencia</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="DRSP" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Análisis de Diagnósticos en el Modelo de Cox</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="residuos-de-cox-snell" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="residuos-de-cox-snell"><span class="header-section-number">5.1</span> Residuos de Cox-Snell</h2>
<p>Suponga que un modelo de Cox se ha ajustado a los datos <span class="math inline">\((T_j,\delta_j,Z_j)\)</span> para <span class="math inline">\(j=1,\ldots,n\)</span>. Además asuma que las covariables son estáticas (no dependen del tiempo). Debido a que:</p>
<p><span class="math display">\[S(X_j|Z_j)=1-F_T(X_j|Z_j)\sim \text{Unif}(0,1)\]</span></p>
<p>Entonces:</p>
<p><span class="math display">\[U=H(X_j|Z_j)=-\log S(X_j|Z_j)\sim \text{Exp}(1)\]</span> donde <span class="math inline">\(X_j\)</span>: tiempo de ocurrencia del riesgo del individuo <span class="math inline">\(j\)</span>-ésimo. Si <span class="math inline">\(b=(b_1,\ldots,b_p)^T\)</span> es un estimador de <span class="math inline">\(\beta\)</span> entonces los residuos de Cox-Snell se definen como:</p>
<p><span class="math display">\[r_j=\hat H_0(t)\exp\left(\sum_{k=1}^pZ_{jk}b_k\right),\qquad j=1,\ldots,n\]</span> donde <span class="math inline">\(\hat H_0(t)\)</span> es el estimador de Breslow de <span class="math inline">\(H_0(t)\)</span>.</p>
<p>Si el modelo de Cox es correcto entonces <span class="math inline">\(\{r_j\}_{j=1}^n\)</span> es una muestra censurada de <span class="math inline">\(\text{Exp}(1)\)</span>.</p>
<ol type="1">
<li>Calcule el estimador de Nelson-Aalen de <span class="math inline">\(H(t)\)</span> usando la muestra <span class="math inline">\(\{r_t\}\)</span>. Bajo la hipótesis de bondad de ajuste:</li>
</ol>
<p><span class="math display">\[H(t)=t\]</span> 2. Grafique <span class="math inline">\(r_j\)</span> versus <span class="math inline">\(\hat H(r_j)\)</span> para <span class="math inline">\(j=1,\ldots,n\)</span>:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Cox_Snell.png" class="img-fluid figure-img" style="width:70.0%"></p>
<p></p><figcaption class="figure-caption">Residuos de Cox-Snell</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p><strong>Nota</strong>: el estimador de Cox-Snell se puede definir en casos en donde las covariables dependen del tiempo y/o modelos estratificados:</p>
<p><span class="math display">\[r_j=\hat H_0(T_j)\exp\left(\sum_{k=1}^pZ_{jk}(T_j)b_k\right),\qquad j=1,\ldots,n\]</span></p>
</section>
<section id="residuos-martingala" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="residuos-martingala"><span class="header-section-number">5.2</span> Residuos Martingala</h2>
<p><strong>Objetivo</strong>: definir posibles transformaciones sobre las covariables que permitan mejorar la capacidad explicativa de un modelo de Cox.</p>
<p>Suponga que <span class="math inline">\(Z_j(t)\)</span> son covariables del individuo <span class="math inline">\(j\)</span>-ésimo en el tiempo <span class="math inline">\(t\)</span>. Defina:</p>
<p><span class="math display">\[N_j(t)=\begin{cases}
1 &amp; \text{individuo j-esimo ha experimentado el riesgo al tiempo t}\\
0 &amp; \text{si no.}
\end{cases}
\]</span></p>
<p><span class="math display">\[Y_j(t)=\begin{cases}
1 &amp; \text{individuo j-esimo está bajo estudio inmediatamente antes del tiempo t}\\
0 &amp; \text{si no.}
\end{cases}
\]</span></p>
<p>El residuo martingala se define como:</p>
<p><span class="math display">\[\hat M_j=N_j(\infty)-\int_0^\infty Y_j(t)\exp[b^TZ_j(t)]d\hat H_0(t)\]</span></p>
<p>si los datos son censurados por la derecha y las covariables son fijas entonces:</p>
<p><span class="math display">\[\hat M_j=\delta_j-\hat H_0(T_j)\exp\left(\sum_{k=1}^pZ_{jk}b_k\right)=\delta_j-r_j \qquad j=1,\ldots,n\]</span></p>
<p><strong>Propiedades</strong>:</p>
<ul>
<li><p><span class="math inline">\(\sum_{j=1}^n \hat M_j=0\)</span></p></li>
<li><p>Para muestras grandes <span class="math inline">\(\{\hat M_j\}\)</span> son variables independientes con medias 0.</p></li>
<li><p>Si <span class="math inline">\(b=\beta\)</span> y <span class="math inline">\(\hat H=H_0\)</span> (valores reales) entonces <span class="math inline">\(M_j\)</span> es martingala ya que:</p></li>
</ul>
<p><span class="math display">\[\hat M_j=\text{número observado de eventos}-\text{número esperado de eventos bajo el modelo de Cox}\]</span></p>
<p>Entonces:</p>
<p><span class="math display">\[E[\hat M_j|\text{Información hasta tiempo t}]=0\]</span></p>
<p>Por otro lado, con el fin de resolver el objetivo, suponga que la covariable <span class="math inline">\(Z\)</span> se divide en dos partes: <span class="math inline">\(Z^*\)</span> (covariables con forma funcional conocida) y <span class="math inline">\(Z_1\)</span> (covariables sin forma funcional conocida).</p>
<p>Suponga además que <span class="math inline">\(Z_1\)</span> es independiente de <span class="math inline">\(Z^*\)</span>.</p>
<p>Sea <span class="math inline">\(f(Z_1)\)</span> la mejor función de <span class="math inline">\(Z_1\)</span> que explica su efecto en la sobrevivencia a través del modelo de Cox:</p>
<p><span class="math display">\[h(t|Z^*,Z_1)=h_0(t)\exp[\beta^*Z^*]\exp[f(Z_1)]\]</span></p>
<p>Procedimiento para encontrar <span class="math inline">\(f\)</span>:</p>
<ol type="1">
<li><p>Ajuste un modelo de Cox usando <span class="math inline">\(Z^*\)</span> y calcule <span class="math inline">\(\hat M_j\)</span> para <span class="math inline">\(j=1,\ldots,n\)</span></p></li>
<li><p>Grafique</p></li>
</ol>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Martingala.png" class="img-fluid figure-img" style="width:70.0%"></p>
<p></p><figcaption class="figure-caption">Residuos Martingala</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section>
<section id="análisis-descriptivo-del-supuesto-de-riesgos-proporcionales" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="análisis-descriptivo-del-supuesto-de-riesgos-proporcionales"><span class="header-section-number">5.3</span> Análisis descriptivo del Supuesto de Riesgos Proporcionales</h2>
<p>Asuma que <span class="math inline">\(Z=(Z_1^T,Z_2^T)^T\)</span> donde <span class="math inline">\(Z_1\)</span>: covariable a la que se le va a analizar el supuesto de riesgos proporcionales y <span class="math inline">\(Z_2\)</span>: vector de <span class="math inline">\(p-1\)</span> restantes covariables. Asuma que no hay interacción entre <span class="math inline">\(Z_1\)</span> y <span class="math inline">\(Z_2\)</span>.</p>
<p><strong>Primer gráfico</strong></p>
<ul>
<li><p>Separe <span class="math inline">\(Z_1\)</span> en <span class="math inline">\(k\)</span> estratos disjuntos (llámese <span class="math inline">\(G_1,\ldots,G_k\)</span> a los estratos en el caso continuo o bien en el caso discreto los valores de <span class="math inline">\(Z_1\)</span> se pueden etiquetar como <span class="math inline">\(1,\ldots,k\)</span>).</p></li>
<li><p>Estime un modelo de Cox estratificado sobre los niveles de <span class="math inline">\(Z_1\)</span>.</p></li>
<li><p>Sea <span class="math inline">\(\hat H_{g0}\)</span> la tasa acumulada base de riesgo en el estrato <span class="math inline">\(g\)</span>-ésimo. (<span class="math inline">\(\hat H_{g0}(t)\)</span> debe ser proporcional entre distintos valores de <span class="math inline">\(g=1,\ldots,k\)</span>).</p></li>
<li><p>Grafique <span class="math inline">\(t\)</span> versus <span class="math inline">\(\log[\hat H_{g0}(t)]\)</span>. Bajo el supuesto de riesgos proporcionales los gráficos deberían ser lineales.</p></li>
<li><p>Otro gráfico posible es <span class="math inline">\(\log[\hat H_{g0}(t)]-\log[\hat H_{10}(t)]\)</span> versus <span class="math inline">\(t\)</span>. En este caso cada gráfico debería ser aproximadamente constante bajo el mismo supuesto.</p></li>
</ul>
<p>Inconveniente: los gráficos no dan información detallada del tipo de desviación que tuvo una covariable con respecto al supuesto de riesgos proporcionales.</p>
<p><strong>Segundo gráfico (Gráfico de Andersen)</strong></p>
<ul>
<li>Grafique <span class="math inline">\(\hat H_{g0}(t)\)</span> versus <span class="math inline">\(\hat H_{10}(t)\)</span> para <span class="math inline">\(g=2,\ldots,k\)</span>. Bajo el supuesto de riesgos proporcionales, las curvas deben ser líneas rectas a través del origen.</li>
</ul>
<p>Si <span class="math inline">\(H_{g0}(t)=e^{\gamma_g}H_{10}(t)\)</span> entonces la pendiente de la curva es un estimador de <span class="math inline">\(e^{\gamma_g}\)</span>.</p>
<p>Inconveniente: la varianza de <span class="math inline">\(\hat H_{g0}(t)\)</span> depende de <span class="math inline">\(t\)</span>, por lo tanto los tres gráficos deben ser interpretados con cuidado.</p>
<p><strong>Tercer gráfico (Gráfico de Arjas)</strong></p>
<p>Suponga que un modelo de Cox ha sido ajustado con un vector <span class="math inline">\(Z^*\)</span> de covariables (de tamaño <span class="math inline">\(p\)</span>) y se quiere comprobar si una nueva covariable <span class="math inline">\(Z\)</span>:</p>
<ul>
<li><p>Debe ser incluida en el modelo.</p></li>
<li><p><span class="math inline">\(Z\)</span> tiene riesgos proporcionales después de incluir <span class="math inline">\(Z^*\)</span>.</p></li>
</ul>
<p>Sea <span class="math inline">\(\hat H(t|Z_j^*)\)</span> la tasa de riesgo del modelo ajustado para el individuo <span class="math inline">\(j\)</span>-ésimo. Bajo una agrupación de la covariable <span class="math inline">\(Z\)</span> en <span class="math inline">\(k\)</span> estratos se calcula para cada uno de ellos:</p>
<p><span class="math display">\[TOT_g(t_i)=\sum_{Z_{1j}=g}\hat H(\min(t_i,T_j)|Z_j^*)\]</span> el cual es el</p>
<p>tiempo total esperado a prueba. El número observado de eventos que han ocurrido hasta tiempo <span class="math inline">\(t_i\)</span> es:</p>
<p><span class="math display">\[N_{g}(t_i)=\sum_{Z_{1j}=g}\delta_j1(T_j\leq t_i)\]</span></p>
<p>Si la covariable <span class="math inline">\(Z\)</span> no necesita estar en el modelo entonces <span class="math inline">\(N_g(t_i)-TOT_g(t_i)\)</span> es una martingala, para cada <span class="math inline">\(g\)</span>.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Arjas.png" class="img-fluid figure-img" style="width:70.0%"></p>
<p></p><figcaption class="figure-caption">Gráfico de Arjas</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Si la covariable <span class="math inline">\(Z\)</span> debe ser incluida en el modelo entonces:</p>
<p><span class="math display">\[h(t|Z=g,Z^*)=h_0(t)\exp(\gamma_g)\exp(\beta^TZ^*)\]</span></p>
<p>y las curvas son aproximadamente lineales con pendientes distintas de 1. Si <span class="math inline">\(Z\)</span> no satisface el principio de riesgos proporcionales entonces las curvas no son lineales y su pendiente difiere de 1.</p>
<p><strong>Cuarto gráfico (Residuos score)</strong></p>
<p>Se ajusta un modelo de Cox sobre las <span class="math inline">\(p\)</span> covariables. Sea <span class="math inline">\(b\)</span> el estimador de verosimilitud parcial de <span class="math inline">\(\beta\)</span> y <span class="math inline">\(\hat H_0(t)\)</span> la tasa de riesgo base estimada. Considere:</p>
<ul>
<li><p><span class="math inline">\(N_j(t)\)</span>: indicadora de que el <span class="math inline">\(j\)</span>-ésimo paciente/sujeto ha</p>
<p>experimentado el riesgo en tiempo <span class="math inline">\(t\)</span></p></li>
<li><p><span class="math inline">\(Y_j(t)\)</span>: indicadora de que el <span class="math inline">\(j\)</span>-ésimo sujeto está bajo estudio</p>
<p>justo antes del tiempo <span class="math inline">\(t\)</span>.</p></li>
</ul>
<p>Para la <span class="math inline">\(k\)</span>-ésima covariable defina:</p>
<p><span class="math display">\[\bar Z_k(t)=\frac{\sum_{j=1}^n Y_j(t)Z_{jk}(t)\exp[b^TZ_j(t)]}{\sum_{j=1}^n Y_j(t)\exp[b^TZ_j(t)]}\]</span></p>
<p>el cual es un promedio ponderado de <span class="math inline">\(Z_{jk}(t)\)</span> y sea <span class="math inline">\(\hat M_j(t)\)</span> el residuo martingala al tiempo <span class="math inline">\(t\)</span> para el individuo <span class="math inline">\(j\)</span>-ésimo:</p>
<p><span class="math display">\[\hat M_j(t)=N_j(t)-\int_0^tY_j(u)\exp[b^TZ_j(u)]d\hat H_0(u)\qquad j=1,\ldots,n\]</span></p>
<p>El residuo score para la <span class="math inline">\(k\)</span>-ésima covariable y el individuo <span class="math inline">\(j\)</span>-ésimo se define como:</p>
<p><span class="math display">\[S_{jk}(t)=\int_0^t[Z_{jk}(u)-\bar Z_k(u)]d\hat M_j(u)\]</span></p>
<p>El proceso score para la <span class="math inline">\(k\)</span>-ésima covariable es:</p>
<p><span class="math display">\[U_k(t)=\sum_{j=1}^n S_{jk}(t)\]</span> En el caso de que todas las covariables son fijas en tiempo 0 entonces:</p>
<p><span class="math display">\[U_k(t)=\sum_{\text{muertes}\leq t}\underbrace{[Z_{jk}-\bar Z_k(T_j)]}_\text{residuos de Schoenfeld}\]</span></p>
<p>Nota: el proceso score <span class="math inline">\(U_k(t)\)</span> es la primera derivada parcial de la verosimilitud parcial del modelo de Cox ajustado con información hasta tiempo <span class="math inline">\(t\)</span>. Además:</p>
<p><span class="math display">\[U_k(0)=0 \qquad \text{y} \qquad U_k(\infty)=0\]</span></p>
<p>dado que <span class="math inline">\(b\)</span> resuelve la ecuación score. Además bajo la hipótesis de que el modelo ajusta bien entonces:</p>
<p><span class="math display">\[W_k(t)=U_k(t)\cdot \text{Error estándar}(b_k)\]</span></p>
<p>y la expresión anterior converge a un puente browniano que se anula en 0 y en <span class="math inline">\(\infty\)</span>, siempre y cuando <span class="math inline">\(\text{Cov}(b_k,b_{k'})=0\)</span> para <span class="math inline">\(k\neq k'\)</span>.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Schoenfeld.png" class="img-fluid figure-img" style="width:70.0%"></p>
<p></p><figcaption class="figure-caption">Residuos de Schoenfeld</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>En el gráfico anterior, en el cuadrante superior se nota que existe evidencia en contra de <span class="math inline">\(H_0\)</span> ya que <span class="math inline">\(W_k(t)\)</span> es superior al cuantil superior bajo <span class="math inline">\(H_0\)</span>, es decir el supuesto de riesgos proporcionales para <span class="math inline">\(Z_k\)</span> no es cierto.</p>
</section>
<section id="identificación-de-outliers" class="level2" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="identificación-de-outliers"><span class="header-section-number">5.4</span> Identificación de Outliers</h2>
<p>Con el fin de detectar outliers podemos usar un gráfico con los residuos</p>
<p>martingala (<span class="math inline">\(\hat M_j\)</span>) vs <span class="math inline">\(j\)</span>.</p>
<p><em>Principal problema:</em> valor máximo del residuo=1 y el valor mínimo del</p>
<p>residuo=<span class="math inline">\(-\infty\)</span>. Por lo tanto los residuos martingala son muy</p>
<p>asimétricos.</p>
<p><em>Solución</em>: modificar <span class="math inline">\(\hat M_j\)</span> a través del residuo de devianza:</p>
<p><span class="math display">\[D_j=\text{signo}[\hat M_j]\cdot \left\{-2\left[\hat M_j+\delta_j\log(\delta_j-\hat M_j)\right] \right\}^{1/2}\]</span></p>
<ul>
<li><p>Si <span class="math inline">\(\hat M_j=0\)</span> entonces <span class="math inline">\(D_j=0\)</span></p></li>
<li><p>Si <span class="math inline">\(\hat M_j\longrightarrow 1\)</span> entonces <span class="math inline">\(D_j\longrightarrow \infty\)</span></p></li>
<li><p>Si <span class="math inline">\(\hat M_j\longrightarrow -\infty\)</span> entonces</p>
<p><span class="math inline">\(D_j\longrightarrow -\infty\)</span> (a una menor tasa).</p></li>
</ul>
<p>Gráfico sugerido (misma interpretación de un gráfico de residuos en</p>
<p>regresión):</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/devianza.png" class="img-fluid figure-img" style="width:70.0%"></p>
<p></p><figcaption class="figure-caption">Residuos de devianza</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>donde el score de riesgo es:</p>
<p><span class="math display">\[\text{Score de riesgo}_j=\sum_{k=1}^p b_kZ_{jk}\]</span> La identificación de</p>
<p>outliers se puede realizar bajo el supuesto de normalidad en los</p>
<p>residuos <span class="math inline">\(N(0,1)\)</span>.</p>
</section>
<section id="gráfico-de-influencia" class="level2" data-number="5.5">
<h2 data-number="5.5" class="anchored" data-anchor-id="gráfico-de-influencia"><span class="header-section-number">5.5</span> Gráfico de Influencia</h2>
<p>Con el fin de verificar el grado de influencia de cada observación en</p>
<p>los estimadores de <span class="math inline">\(\beta\)</span>, se compara <span class="math inline">\(b\)</span> con <span class="math inline">\(b_{(j)}\)</span>: estimador de</p>
<p><span class="math inline">\(\beta\)</span> quitando la <span class="math inline">\(j\)</span>-ésima observación. Esto se hace simplemente a</p>
<p>través de la diferencia <span class="math inline">\(b-b_{(j)}\)</span>, en el sentido de que si <span class="math inline">\(b-b_{(j)}\)</span></p>
<p>es pequeño, entonces la observación tiene poca influencia.</p>
<p><em>Problema</em>: el procedimiento anterior implica realizar <span class="math inline">\(n+1\)</span> regresiones</p>
<p>de Cox.</p>
<p><em>Solución</em>: usar una aproximación para no tener que calcular todas las</p>
<p>regresiones.</p>
<p>Sea <span class="math inline">\(S_{jk}=S_{jk}(\infty)\)</span> (residuo score). Si todas las covariables</p>
<p>son fijas en tiempo 0:</p>
<p><span class="math display">\[S_{jk}=\underbrace{\delta_j[Z_{jk}-\bar Z_k(T_j)]}_{\text{Residuo parcial de Schoenfeld}}-\sum_{t_b\leq T_j}[Z_{jk}-\bar Z_k(T_b)]\exp(b^TZ_j)\cdot [\hat H_0(t_b)-\hat H_0(t_{b-1})]\]</span></p>
<p>para <span class="math inline">\(j=1,\ldots,n\)</span> y <span class="math inline">\(k=1,\ldots,p\)</span>.</p>
<p>Se puede comprobar que <span class="math inline">\(b-b_{(j)}\approx \Delta_j\)</span> donde:</p>
<p><span class="math display">\[\Delta_j=I(b)^{-1}(S_{j1},\ldots,S_{jp})^T\]</span></p>
<p>donde <span class="math inline">\(I(b)\)</span> es la información de Fisher observada.</p>
<p>Gráficos:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/influencia.png" class="img-fluid figure-img" style="width:70.0%"></p>
<p></p><figcaption class="figure-caption">Gráficos de Influencia</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>en donde el gráfico de la derecha muestra el nivel de influencia de las</p>
<p>observaciones sobre la <span class="math inline">\(k\)</span>-ésima covariable.</p>
<!-- ## Laboratorio -->
<!-- ### Ejemplo 1 -->
<!-- En este ejemplo retomamos los datos de pacientes que han tenido un -->
<!-- transplante de médula ósea y se analiza el riesgo de muerte o -->
<!-- reaparición de la leucemia. Cargamos datos y paquetes: -->
<!-- ```{r message=FALSE, warning=FALSE} -->
<!-- library(survival) -->
<!-- library(survMisc) -->
<!-- library(KMsurv) -->
<!-- library(tidyverse) -->
<!-- library(survminer) -->
<!-- data(bmt) -->
<!-- ``` -->
<!-- Ajustamos un modelo de Cox con las siguientes covariables: -->
<!-- ```{r} -->
<!-- bmt <- bmt %>%  -->
<!--   mutate(waiting=z7/30-9,FAB=factor(z8), -->
<!--                       MTX=factor(z10),SXPa=factor(z3), -->
<!--                       SXDo=factor(z4),CMVPa=factor(z5),    -->
<!--                     CMVDo=factor(z6),AgePa=z1-28,AgeDo=z2-28, -->
<!--                       group=factor(group)) -->
<!-- bmt_2 <- bmt %>% select(t2,d3,group,waiting,FAB,MTX,AgePa, -->
<!--                         AgeDo) -->
<!-- modelo1 <- coxph(Surv(time=t2, event=d3)~AgePa*AgeDo+group+FAB+waiting+MTX,data = bmt_2) -->
<!-- summary(modelo1) -->
<!-- ``` -->
<!-- Antes de calcular los residuos de Cox-Snell calculamos los residuos -->
<!-- Martingala, y después los obtenemos por diferencia con respecto a los -->
<!-- eventos observados: -->
<!-- ```{r} -->
<!-- bmt_2$rMart <- residuals(modelo1,type = 'martingale') -->
<!-- bmt_2$rCox <- bmt$d3-bmt_2$rMart -->
<!-- ``` -->
<!-- Ahora calculamos el estimador de Nelson-Aalen usando como tiempos los -->
<!-- residuos de Cox-Snell: -->
<!-- ```{r} -->
<!-- modelo1_CoxSnell <- coxph(Surv(rCox,d3)~1,data = bmt_2,ties = 'breslow') -->
<!-- ``` -->
<!-- y calculamos la tasa acumulada: -->
<!-- ```{r} -->
<!-- H0_modelo1_CS <- basehaz(modelo1_CoxSnell,centered = FALSE) -->
<!-- plot(H0_modelo1_CS$time,H0_modelo1_CS$hazard) -->
<!-- abline(a = 0,b=1) -->
<!-- ``` -->
<!-- de donde se puede concluir que el ajuste no es malo. Anteriormente -->
<!-- habíamos puesto en duda el supuesto de riesgos proporcionales en la -->
<!-- variable MTX. Hacemos el gráfico para los dos niveles de la variable MTX -->
<!-- y los comparamos: -->
<!-- ```{r} -->
<!-- modelo1_CoxSnell_MTX1 <- coxph(Surv(rCox,d3)~1,data = subset(bmt_2,MTX==1),ties = 'breslow') -->
<!-- modelo1_CoxSnell_MTX0 <- coxph(Surv(rCox,d3)~1,data = subset(bmt_2,MTX==0),ties = 'breslow') -->
<!-- H0_modelo1_CS_MTX1 <- basehaz(modelo1_CoxSnell_MTX1,centered = FALSE) -->
<!-- H0_modelo1_CS_MTX0 <- basehaz(modelo1_CoxSnell_MTX0,centered = FALSE) -->
<!-- plot(H0_modelo1_CS_MTX0$time,H0_modelo1_CS_MTX0$hazard,type='l',xlab='Tiempo',ylab='H0') -->
<!-- lines(H0_modelo1_CS_MTX1$time,H0_modelo1_CS_MTX1$hazard,lty=2) -->
<!-- abline(a = 0,b=1) -->
<!-- legend(x = 0,y = 3,legend = c('MTX=0','MTX=1'),lty=c(1,2)) -->
<!-- ``` -->
<!-- A partir de este gráfico vemos que el supuesto de riesgos proporcionales -->
<!-- no es tan evidente para la covariable MTX. Una posible forma de -->
<!-- solucionarlo es a través de un modelo estratificado. Ejercicio: Repetir -->
<!-- el procedimiento anterior con el modelo estratificado y comparar con la -->
<!-- figura 11.3 del Klein. -->
<!-- Otra posible forma de verificar gráficamente el supuesto de riesgos -->
<!-- proporcionales es a través del proceso score, el cual es calculado -->
<!-- usando los residuos de Schoenfeld sobre los riesgos observados: -->
<!-- ```{r} -->
<!-- rSchoen <- residuals(modelo1,type = 'schoenfeld') -->
<!-- muertes <- bmt_2 %>% filter(d3==1) %>% mutate(rSchoen_MTX=rSchoen[,7],rSchoen_wait=rSchoen[,6])%>% -->
<!--   arrange(t2)%>% mutate(Uk_MTX=cumsum(rSchoen_MTX),Uk_wait=cumsum(rSchoen_wait)) -->
<!-- resumen_m1 <- summary(modelo1) -->
<!-- plot(muertes$t2,resumen_m1$coefficients[7,3]*muertes$Uk_MTX,type='l',xlab='Tiempo',ylab='Score Estandarizado') -->
<!-- abline(h=c(-1.3581,1.3581)) -->
<!-- plot(muertes$t2,resumen_m1$coefficients[6,3]*muertes$Uk_wait,type='l',xlab='Tiempo',ylab='Score Estandarizado') -->
<!-- abline(h=c(-1.3581,1.3581)) -->
<!-- ``` -->
<!-- En ambos casos no se sobrepasa los umbrales de confianza de un puente -->
<!-- Browniano al 95%, pero hay más evidencia (aunque muy poca) de que la -->
<!-- variable MTX no satisface el supuesto de riesgos proporcionales. -->
<!-- ### Ejemplo 2 -->
<!-- El siguiente ejemplo es de 43 pacientes que recibieron un transplante de -->
<!-- médula ósea que tenían la enfermedad de Hodgkin (HOD) o el linfoma -->
<!-- no-Hodgkin (NHL) (dtype) y se le suministró dos tipos distintos de -->
<!-- transplantes (gtype: Allo, Auto). Dos covariables adicionales son el -->
<!-- score de Karnofsky (score) y el tiempo de espera desde el diagnóstico -->
<!-- hasta el transplante (wtime). Carga de datos: -->
<!-- ```{r} -->
<!-- data(hodg) -->
<!-- head(hodg) -->
<!-- ``` -->
<!-- Ahora se determinará la mejor transformación de la variable wtime para -->
<!-- el análisis a través de los residuos martingala del modelo reducido sin -->
<!-- la variable wtime: -->
<!-- ```{r} -->
<!-- hodg <- hodg %>% mutate(gtype=factor(gtype),dtype=factor(dtype)) -->
<!-- modelo2_ww <- coxph(Surv(time,delta)~gtype*dtype+score,data = hodg) -->
<!-- residuos_mart_w <- residuals(modelo2_ww,type = 'martingale') -->
<!-- datos_mart <- hodg %>% select(wtime) %>% mutate(rMart=residuos_mart_w) -->
<!-- grafico_mart <- ggplot(data = datos_mart,mapping = aes(x=wtime,y = rMart))+geom_point()+geom_smooth() -->
<!-- grafico_mart -->
<!-- ``` -->
<!-- En donde se puede observar que hay un comportamiento muy diferente en -->
<!-- los residuos martingala antes y después de 75 meses. Una posible -->
<!-- solución es usar una indicadora a los 75 meses. Usando las técnicas de -->
<!-- discretización de variables que vimos en el capítulo 8 (prueba de -->
<!-- Contal-O'Quigley): -->
<!-- ```{r} -->
<!-- modelo2 <- coxph(Surv(time,delta)~gtype*dtype+score+wtime,data = hodg) -->
<!-- Contal_modelo2 <- cutp(modelo2) -->
<!-- Contal_modelo2$wtime[1,] -->
<!-- ``` -->
<!-- Por lo tanto se selecciona un corte de 84 meses para la definición de la -->
<!-- indicadora. Definimos la variable indicadora: -->
<!-- ```{r} -->
<!-- hodg <- hodg %>% mutate(i_wtime=ifelse(wtime>=84,1,0)) -->
<!-- contrasts(hodg$gtype) <- contr.treatment(n = 2,base = 2) -->
<!-- contrasts(hodg$dtype) -->
<!-- modelo2_wi <- coxph(Surv(time,delta)~gtype*dtype+score+i_wtime,data = hodg) -->
<!-- summary(modelo2_wi) -->
<!-- ``` -->
<!-- En este caso graficamos los residuos de devianza vs los scores de -->
<!-- riesgo: -->
<!-- ```{r} -->
<!-- ggcoxdiagnostics(modelo2_wi,type = 'deviance',ggtheme = theme_bw()) -->
<!-- ``` -->
<!-- donde podemos observar que hay un par de individuos con valores -->
<!-- relativamente altos en su residuos de devianza: -->
<!-- ```{r} -->
<!-- hodg <- hodg %>% mutate(rDev=residuals(modelo2_wi,type = 'deviance')) -->
<!-- mayores_dev <- hodg %>% arrange(desc(rDev)) -->
<!-- mayores_dev[1:2,] -->
<!-- ``` -->
<!-- Noten que los dos individuos fallecieron al mes aproximadamente, pero -->
<!-- sus scores de riesgo eran bajos, es decir se esperaba que los dos -->
<!-- sobrevivieran más. -->
<!-- Ahora graficamos los estadísticos de influencia de las observaciones: -->
<!-- ```{r} -->
<!-- ggcoxdiagnostics(modelo2_wi,type = 'dfbetas') -->
<!-- influence_m <- residuals(modelo2_wi,type = 'dfbetas') -->
<!-- ``` -->
<!-- Note que el individuo con mayor influencia en la estimación del score es -->
<!-- el número 1: -->
<!-- ```{r} -->
<!-- which.max(influence_m[,3]) -->
<!-- hodg[which.max(abs(influence_m[,3])),] -->
<!-- ``` -->
<!-- y es un individuo con un score relativamente alto (indicador de buen -->
<!-- estado físico) pero murió en un momento muy temprano (1 mes -->
<!-- aproximadamente). Este individuo es el mismo con un residuo de devianza alto. -->


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./RSP.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Regresión Semiparamétrica con Riesgos Proporcionales</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./references.html" class="pagination-link">
        <span class="nav-page-text">Referencias</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>